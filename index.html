    <title>BL4 Weapon Part Editor (Hosted)</title>
    <style>
        /* Base styles adapted from Enhancement_Editor.html */
        :root { --bg:#0b0f14; --card:#0e1520; --ink:#e6f0ff; --muted:#a6b4c8; --line:#1f2a3a; --accent-orange: #e59400; --danger-red: #e74c3c; --success-green: #28a745; --edit-yellow: #ffc107; }
        * { box-sizing: border-box; }
        body { font-family: 'Inter', system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--ink); padding: 0; /* Remove body padding */ font-size: 16px; line-height: 1.5; margin: 0; }

        /* --- TAB NAVIGATION STYLES --- */
        /* ... existing tab styles ... */
        .tab-nav { background-color: var(--card); border-bottom: 1px solid var(--line); padding: 0 18px; margin-bottom: 18px; display: flex; gap: 10px; }
        .tab-link { display: inline-block; padding: 12px 16px; color: var(--muted); text-decoration: none; border-bottom: 3px solid transparent; transition: color 0.2s ease, border-color 0.2s ease; font-weight: 500; font-size: 15px; }
        .tab-link:hover { color: var(--ink); }
        .tab-link.active { color: var(--accent-orange); border-bottom-color: var(--accent-orange); }

        .container { max-width: 1200px; margin: 0 auto; padding: 0 18px 18px 18px; /* Padding moved here */ }
        h2 { margin: 0 0 14px; border-bottom: 1px solid var(--line); padding-bottom: 8px; font-weight: 700; display: flex; justify-content: space-between; align-items: center; } /* Make h2 a flex container */
        .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
        .card { background: var(--card); border: 1px solid var(--line); border-radius: 14px; padding: 14px 16px; display: flex; flex-direction: column; margin-bottom: 14px; }
        label { color: var(--muted); font-size: 12px; display: block; margin-bottom: 6px; font-weight: 400; }
        select, input, button { background: #0f1720; color: var(--ink); border: 1px solid var(--line); border-radius: 10px; padding: 10px 12px; font-size: 16px; font-family: inherit; }
        input::placeholder { color: var(--muted); opacity: 0.7; }
        select[multiple] { padding: 4px; }
        select:focus, input:focus, button:focus { outline: 2px solid var(--accent-orange); outline-offset: 1px; border-color: var(--accent-orange); }
        code { background:#0c121b; border: 1px solid var(--line); padding: 4px 8px; display: inline-block; border-radius: 6px; font-size: 0.9em; font-family: monospace; }
        button { cursor: pointer; background-color: #2c2c4d; transition: background-color 0.2s ease; }
        button:hover { background-color: #4b4b7d; }
        button:disabled { background-color: #2c2c4d; opacity: 0.5; cursor: not-allowed; }
        button.small { padding: 6px 10px; border-radius: 8px; font-size: 14px; min-height: 38px; min-width: 38px; }
        .wrap { white-space: normal; word-break: break-word; }

        /* --- COLLAPSIBLE STYLES --- */
        /* ... existing collapsible styles ... */
        .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; margin-top: 0; }
        .collapsible-content.expanded { max-height: 1000px; margin-top: 14px; }
        .toggle-btn { background: none; border: none; color: var(--muted); font-size: 1.5em; line-height: 1; padding: 0 5px; cursor: pointer; opacity: 0.7; transition: opacity 0.2s, color 0.2s; margin-left: 10px; }
        .toggle-btn:hover { opacity: 1; }
        .toggle-btn::before { content: '[+]'; color: var(--success-green); }
        .toggle-btn.expanded::before { content: '[-]'; color: var(--danger-red); }
        .builderSection .row.titleRow { justify-content: space-between; align-items: center; padding-bottom: 8px; margin-bottom: 0; border-bottom: 1px solid var(--line); }
        .builderSection .row.titleRow > div:first-child { font-weight: 700; color: var(--muted); font-size: 1.1em; border-bottom: none; padding-bottom: 0; margin-bottom: 0; flex-grow: 1; }
        .builderSection .row.filterRow { flex-grow: 0; flex-shrink: 0; width: auto; }

        /* --- END COLLAPSIBLE STYLES --- */

        /* ... existing builder, output, input, message styles ... */
        .builderSection .row.selects { margin-top: 8px; display: flex; gap: 10px; align-items: stretch; }
        .builderSection select { flex: 1; min-height: 220px; width: 100%; border-radius: 8px;}
        .builderSection .buttons { display: flex; flex-direction: column; gap: 8px; justify-content: center; width: 56px; align-items: center; }
        .builderSection .tip { margin-top: 10px; font-size: 12px; color: var(--muted); }
        .outCard code { display: block; overflow: auto; width: 100%; white-space: pre-wrap; word-break: break-all; max-height: 100px; min-height: 50px; background: #0c121b; padding: 10px; border-radius: 8px; border: 2px solid var(--line); transition: border-color 0.3s ease; }
        .outCard code[contenteditable="true"]:focus { outline: none; border-color: var(--edit-yellow); }
        .outCard code.manual-edit { border-color: var(--edit-yellow); }
        #apiCard code { max-height: 100px; }
        .sticky { position: sticky; top: 0; z-index: 20; background: var(--bg); }
        #inputSerialCode { width: 100%; min-height: 40px; margin-top: 6px; padding: 8px 10px; background: #141c27; color: var(--ink); border: 1px solid var(--line); border-radius: 8px; font-family: monospace; font-size: 0.9em; }
        #message-area { padding: 10px 18px; margin-bottom: 14px; border-radius: 8px; font-size: 14px; display: none; border: 1px solid transparent; } /* Kept for fallback, but toasts preferred */
        #message-area.visible { display: block; }
        #message-area.error { background-color: rgba(231, 76, 60, 0.2); border-color: var(--danger-red); color: var(--danger-red); }
        #message-area.success { background-color: rgba(40, 167, 69, 0.2); border-color: var(--success-green); color: var(--success-green); }
        .copy-status { font-size: 12px; color: var(--muted); margin-left: 5px; opacity: 0; transition: opacity 0.3s ease; }
        .copy-status.visible { opacity: 1; }
        .manual-edit-indicator { display: none; font-size: 11px; color: var(--edit-yellow); margin-left: 8px; }
        .outCard.manual-edit .manual-edit-indicator { display: inline; }

        /* --- NEW Loading Overlay & Spinner Styles --- */
        .loading-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7); /* Darker overlay */
            backdrop-filter: blur(5px);
            display: none; /* Hidden by default */
            align-items: center; justify-content: center;
            z-index: 9999;
        }
        .loading-overlay.show { display: flex; }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top: 4px solid var(--accent-orange); /* Accent color */
            border-radius: 50%;
            width: 50px; height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* --- END Loading Overlay Styles --- */

        /* --- NEW Message Toast Styles --- */
        .message-toast {
            position: fixed;
            bottom: 20px; /* Position at bottom */
            left: 50%; /* Center horizontally */
            transform: translateX(-50%); /* Adjust centering */
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            display: none; /* Hidden by default */
            align-items: center;
            gap: 10px;
            z-index: 10000;
            opacity: 0;
            transition: opacity 0.3s ease, bottom 0.3s ease;
            font-size: 15px;
        }
        .message-toast.show {
            display: flex;
            opacity: 1;
            bottom: 30px; /* Slide up slightly */
        }
        .message-toast.success { background: rgba(40, 167, 69, 0.9); border: 1px solid var(--success-green); color: #fff; }
        .message-toast.error { background: rgba(231, 76, 60, 0.9); border: 1px solid var(--danger-red); color: #fff; }
        .message-toast.info { background: rgba(44, 44, 77, 0.95); border: 1px solid var(--line); color: var(--ink); } /* Info style */
        .toast-icon { font-size: 1.2em; line-height: 1; }
        /* --- END Message Toast Styles --- */


        /* Responsive Adjustments */
        @media (max-width: 768px) {
            /* ... existing responsive styles ... */
            .tab-nav { padding: 0 10px; margin-bottom: 10px; }
            .tab-link { padding: 10px 8px; font-size: 14px; }
            .container { padding: 0 10px 10px 10px; }
            .outCard code { max-height: 120px; }
            .outCard .row { flex-wrap: wrap; }
            .outCard .row button.small { min-height: 30px; }
            #dice { padding: 4px 8px !important; font-size: 12px !important; }
            .builderSection .row.titleRow { flex-wrap: wrap; }
            .builderSection .row.filterRow { width: 100%; justify-content: space-between; margin-top: 5px;}
            .message-toast { width: calc(100% - 40px); left: 20px; transform: none; } /* Adjust toast for mobile */
        }
    </style>
</head>
<body class="loading">

    <!-- TAB NAVIGATION BAR -->
    <nav class="tab-nav">
        <a href="Deseralizer Comparator.html" class="tab-link">Comparator & Editor</a>
        <a href="Deseralizer Comparator.html#deserializer" class="tab-link">Deserializer</a>
        <a href="bl4_decoder.html" class="tab-link active">Workstation</a>
    </nav>

<div class="container">
    <div id="message-area"></div> <!-- Kept as fallback -->

    <!-- ... rest of existing HTML structure (h2, inputCard, outCard, apiCard, mainContent with collapsible cards) ... -->
    <h2>BL4 Weapon Part Editor (Workstation)</h2>

    <div class="card" id="inputCard">
        <label>Input Base Serial String (Editable)</label>
        <code id="inputSerialCode" contenteditable="plaintext-only" title="Enter a base serial string here. Selected parts will be appended to this string."></code>
    </div>

    <div class="card outCard sticky">
        <div class="row" style="justify-content: space-between; align-items: center;">
            <div style="color:var(--muted)">Output Serial String <span class="manual-edit-indicator">(Manual Edit Mode)</span></div>
            <div class="row">
                 <button class="small" id="reserializeManual" title="Reserialize Manual Edit">üîÑ API</button>
                 <button class="small" id="undoEdit" title="Undo Manual Edit & Rebuild">‚Ü©Ô∏è Undo</button>
                 <button class="small" id="copyFull" title="Copy Output String">üìã</button>
                 <span id="copyFullStatus" class="copy-status"></span>
            </div>
        </div>
        <div id="out" style="margin-top:6px"><code contenteditable="plaintext-only"><!-- Output code will appear here --></code></div>
         <button class="small" id="dice" title="New random seed" style="margin-top: 10px; width: fit-content;">üé≤ New Seed</button>
    </div>

     <div class="card" id="apiCard" style="margin-bottom:14px">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
            <div>
                <div style="color:var(--muted)">Validated Serial (API Result)</div>
                <div id="serialWrap" style="margin-top:6px"><code id="serial_b85"><!-- API Serial B85 --></code></div>
                <div id="addDataWrap" style="margin-top:6px;color:var(--muted); font-size: 12px;">
                    <span style="opacity:.8">Details:</span> <code id="additionalData" style="font-size: 12px;"><!-- API Additional Data --></code>
                </div>
            </div>
            <div class="row" style="gap:8px">
                <button class="small" id="copySerial" title="Copy API Serial" disabled>üìã</button>
                <span id="copyApiStatus" class="copy-status"></span>
            </div>
        </div>
    </div>

     <div id="mainContent">
         {/* ... Collapsible cards ... */}
        <div class="card collapsible" id="baseItemCard">
             <h2>Base Item Properties</h2>
             <div class="collapsible-content">
                 <div class="row">
                    <div style="flex: 1;">
                        <label>Base Item Type (Placeholder)</label>
                        <select id="itemTypeSel">
                            <option value="gun">Generic Gun</option>
                            <option value="shield">Shield</option>
                            <option value="grenade">Grenade Mod</option>
                            <option value="classmod">Class Mod</option>
                            <option value="enhancement">Enhancement</option>
                        </select>
                    </div>
                     <div style="flex: 1;">
                        <label>Rarity (Placeholder)</label>
                        <select id="raritySel">
                            <option value="common">Common</option>
                            <option value="uncommon">Uncommon</option>
                            <option value="rare">Rare</option>
                            <option value="epic">Epic</option>
                            <option value="legendary">Legendary</option>
                        </select>
                    </div>
                 </div>
             </div>
        </div>
        <div class="card builderSection collapsible" data-key="legendaryPerks" data-name-field="name" data-code-field="code" data-id-prefix="LegPerk">
             <div class="row titleRow">
                 <div>Legendary Perk Part Variations</div>
                 <div class="row filterRow">
                    <input id="filterLegPerk" placeholder="Filter..." type="text"/>
                    <button class="small" id="clearLegPerk" title="Clear Selected">‚ùå</button>
                </div>
            </div>
             <div class="collapsible-content">
                <div class="row selects">
                    <select id="availLegPerk" multiple size="8" aria-label="Available Legendary Perks"></select>
                    <div class="buttons">
                        <button id="addLegPerk" title="Add Selected">¬ª</button>
                        <button id="remLegPerk" title="Remove Selected">¬´</button>
                    </div>
                    <select id="selLegPerk" multiple size="8" aria-label="Selected Legendary Perks"></select>
                </div>
                 <div class="tip">Double-click to add/remove. Condenses multiple identical IDs.</div>
             </div>
        </div>
        <div class="card builderSection collapsible" data-key="altFireModes" data-name-field="name" data-code-field="code" data-id-prefix="AltFire">
            <div class="row titleRow">
                <div>Alt Fire Mode Variations</div>
                <div class="row filterRow">
                    <input id="filterAltFire" placeholder="Filter..." type="text"/>
                    <button class="small" id="clearAltFire" title="Clear Selected">‚ùå</button>
                </div>
            </div>
             <div class="collapsible-content">
                <div class="row selects">
                    <select id="availAltFire" multiple size="8" aria-label="Available Alt Fire Modes"></select>
                    <div class="buttons">
                        <button id="addAltFire" title="Add Selected">¬ª</button>
                        <button id="remAltFire" title="Remove Selected">¬´</button>
                    </div>
                    <select id="selAltFire" multiple size="8" aria-label="Selected Alt Fire Modes"></select>
                </div>
                 <div class="tip">Double-click to add/remove. Condenses multiple identical IDs.</div>
            </div>
        </div>
        <div class="card builderSection collapsible" data-key="magazineModes" data-name-field="name" data-code-field="code" data-id-prefix="MagMode">
             <div class="row titleRow">
                <div>Magazine / Ammo Mode Variations</div>
                 <div class="row filterRow">
                    <input id="filterMagMode" placeholder="Filter..." type="text"/>
                    <button class="small" id="clearMagMode" title="Clear Selected">‚ùå</button>
                </div>
            </div>
             <div class="collapsible-content">
                <div class="row selects">
                    <select id="availMagMode" multiple size="8" aria-label="Available Magazine/Ammo Modes"></select>
                    <div class="buttons">
                        <button id="addMagMode" title="Add Selected">¬ª</button>
                        <button id="remMagMode" title="Remove Selected">¬´</button>
                    </div>
                    <select id="selMagMode" multiple size="8" aria-label="Selected Magazine/Ammo Modes"></select>
                </div>
                 <div class="tip">Double-click to add/remove. Condenses multiple identical IDs.</div>
             </div>
        </div>
        <div class="card builderSection collapsible" data-key="ordnancePerks" data-name-field="name" data-code-field="code" data-id-prefix="OrdPerk">
             <div class="row titleRow">
                <div>Ordnance Legendary Perks (Heavy/Grenade)</div>
                 <div class="row filterRow">
                    <input id="filterOrdPerk" placeholder="Filter..." type="text"/>
                    <button class="small" id="clearOrdPerk" title="Clear Selected">‚ùå</button>
                </div>
            </div>
             <div class="collapsible-content">
                <div class="row selects">
                    <select id="availOrdPerk" multiple size="8" aria-label="Available Ordnance Perks"></select>
                    <div class="buttons">
                        <button id="addOrdPerk" title="Add Selected">¬ª</button>
                        <button id="remOrdPerk" title="Remove Selected">¬´</button>
                    </div>
                    <select id="selOrdPerk" multiple size="8" aria-label="Selected Ordnance Perks"></select>
                </div>
                 <div class="tip">Double-click to add/remove. Condenses multiple identical IDs.</div>
             </div>
        </div>

    </div>

</div> <!-- End container -->

<!-- NEW HTML: Loading Overlay and Message Toast -->
<div id="loadingOverlay" class="loading-overlay">
    <div style="text-align: center;">
        <div class="spinner"></div>
        <p style="margin-top: 20px; font-size: 1.2em;">Processing...</p>
    </div>
</div>
<div id="messageToast" class="message-toast">
    <span id="toastIcon" class="toast-icon">‚úì</span>
    <span id="toastText">Success!</span>
</div>
<!-- END NEW HTML -->

<script>
    // ... (Existing Global variables, DOM cache - unchanged) ...
    let PAYLOAD = {};
    const builders = {};
    let rndSeed = Math.floor(1000 + Math.random() * 9000);
    let apiCallTimer;
    let rebuildTimer;
    let lastGeneratedOutput = '';
    let isManualEditMode = false;
    let messageTimeout; // Timeout ID for toast messages

    const dom = {
        body: document.body,
        messageArea: document.getElementById('message-area'), // Kept for fallback
        itemTypeSel: document.getElementById('itemTypeSel'),
        raritySel: document.getElementById('raritySel'),
        outWrapper: document.getElementById('out'),
        outCode: document.querySelector('#out code'),
        inputSerialCode: document.getElementById('inputSerialCode'),
        serial_b85: document.getElementById('serial_b85'),
        additionalData: document.getElementById('additionalData'),
        copyFull: document.getElementById('copyFull'),
        copySerial: document.getElementById('copySerial'),
        dice: document.getElementById('dice'),
        copyFullStatus: document.getElementById('copyFullStatus'),
        copyApiStatus: document.getElementById('copyApiStatus'),
        undoEditBtn: document.getElementById('undoEdit'),
        reserializeManualBtn: document.getElementById('reserializeManual'),
        // NEW: Loading overlay and Toast elements
        loadingOverlay: document.getElementById('loadingOverlay'),
        messageToast: document.getElementById('messageToast'),
        toastIcon: document.getElementById('toastIcon'),
        toastText: document.getElementById('toastText')
    };

    // --- UPDATED Utility Functions ---
    function showLoading(show) {
        if (!dom.loadingOverlay) return;
        if (show) {
            dom.loadingOverlay.classList.add('show');
        } else {
            dom.loadingOverlay.classList.remove('show');
        }
    }

    // NEW showMessage function using toasts
    function showMessage(text, type = 'info', duration = 3000) {
        if (!dom.messageToast || !dom.toastIcon || !dom.toastText) {
            // Fallback to old message area if toast elements are missing
            console.warn("Toast elements not found, using fallback message area.");
            const oldMessageArea = document.getElementById('message-area');
            if (oldMessageArea) {
                oldMessageArea.innerHTML = text.replace(/<code>(.*?)<\/code>/g, '$1'); // Basic HTML removal
                oldMessageArea.className = `message-area visible ${type === 'success' ? 'success' : type === 'error' ? 'error' : ''}`;
                oldMessageArea.style.display = 'block';
                 if (type !== 'error') {
                     clearTimeout(oldMessageArea.timer);
                     oldMessageArea.timer = setTimeout(() => {
                         oldMessageArea.style.display = 'none';
                         oldMessageArea.classList.remove('visible');
                     }, duration);
                 }
            }
            return;
        }

        clearTimeout(messageTimeout); // Clear previous toast timeout

        dom.toastIcon.textContent = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è';
        dom.toastText.innerHTML = text; // Allow simple HTML like <code>
        dom.messageToast.className = `message-toast ${type} show`;

        messageTimeout = setTimeout(() => {
            dom.messageToast.classList.remove('show');
        }, duration);
    }

    function showCopyStatus(statusElement, message) { // Keep using inline status for copy
        if (!statusElement) return;
        statusElement.textContent = message;
        statusElement.classList.add('visible');
        clearTimeout(statusElement.timer);
        statusElement.timer = setTimeout(() => {
            statusElement.classList.remove('visible');
        }, 1500);
    }

    // --- Collapsible Section Logic (unchanged) ---
    function setupCollapsibleSections() {
        // ... (setupCollapsibleSections function unchanged) ...
        const collapsibleCards = document.querySelectorAll('.card.collapsible');
        collapsibleCards.forEach(card => {
            const header = card.querySelector('h2') || card.querySelector('.row.titleRow');
            const content = card.querySelector('.collapsible-content');
            if (!header || !content) { console.warn('Collapsible structure incorrect:', card); return; }
            const toggleBtn = document.createElement('button');
            toggleBtn.className = 'toggle-btn';
            toggleBtn.setAttribute('aria-expanded', 'false');
            toggleBtn.title = 'Toggle Section';
            if (header.tagName === 'H2') { header.appendChild(toggleBtn); }
            else if (header.classList.contains('titleRow')) {
                 const titleDiv = header.querySelector('div:first-child');
                 if (titleDiv) { titleDiv.insertAdjacentElement('afterend', toggleBtn); }
                 else { header.appendChild(toggleBtn); }
            }
            toggleBtn.addEventListener('click', () => {
                const isExpanded = content.classList.toggle('expanded');
                toggleBtn.classList.toggle('expanded', isExpanded);
                toggleBtn.setAttribute('aria-expanded', isExpanded);
            });
        });
    }

    // --- Generic Builder UI Logic (unchanged) ---
    function createBuilder(key, nameField, codeField, idPrefix) {
        // ... (createBuilder function unchanged) ...
        const dataList = PAYLOAD[key] || [];
        const filterInput = document.getElementById(`filter${idPrefix}`);
        const availList = document.getElementById(`avail${idPrefix}`);
        const selList = document.getElementById(`sel${idPrefix}`);
        const addBtn = document.getElementById(`add${idPrefix}`);
        const remBtn = document.getElementById(`rem${idPrefix}`);
        const clearBtn = document.getElementById(`clear${idPrefix}`);
        if (!filterInput || !availList || !selList || !addBtn || !remBtn || !clearBtn) { /* ... error handling ... */ throw new Error(`Missing DOM elements for builder ${idPrefix}`); }
        let selectedItems = []; const codeToNameMap = {};
        if (!Array.isArray(dataList)) { throw new Error(`Expected array for key ${key}`); }
        dataList.forEach(item => { /* ... populate codeToNameMap ... */
            const code = item[codeField]; if (code === undefined || code === null) return;
            const name = item[nameField] || 'Unnamed Item'; const variant = item.variant ? ` "${item.variant}"` : ''; const group = item.group ? ` (${item.group})` : ''; codeToNameMap[code] = `${name}${variant}${group}`; });
        function populateAvailable() { /* ... filter and populate availList ... */
            const fragment = document.createDocumentFragment(); const query = (filterInput.value || '').toLowerCase(); availList.innerHTML = '';
            (dataList || []).filter(item => { const code = item[codeField]; if (code === undefined || code === null) return false; const name = codeToNameMap[code] || ''; const searchText = `${name} {${code}}`.toLowerCase(); return !query || searchText.includes(query); })
            .sort((a, b) => { const nameA = codeToNameMap[a[codeField]] || ''; const nameB = codeToNameMap[b[codeField]] || ''; return nameA.localeCompare(nameB); })
            .forEach(item => { const code = item[codeField]; const displayName = codeToNameMap[code]; const o = document.createElement('option'); o.value = code; o.textContent = `${displayName} {${code}}`; fragment.appendChild(o); });
            availList.appendChild(fragment); }
        function renderSelected() { /* ... update selList preserving selection/scroll ... */
            const scrollState = { top: selList.scrollTop, left: selList.scrollLeft }; const selectedValues = new Set(Array.from(selList.selectedOptions).map(opt => opt.value)); selList.innerHTML = '';
            selectedItems.forEach((code, index) => { const name = codeToNameMap[code] || 'Unknown Code'; const o = document.createElement('option'); o.value = code; o.textContent = `${name} {${code}}`; o.dataset.index = index; if (selectedValues.has(code)) { o.selected = true; } selList.appendChild(o); });
            selList.scrollTop = scrollState.top; selList.scrollLeft = scrollState.left; if (!isManualEditMode) { triggerDebouncedRebuild(); } }
        function addSelected() { Array.from(availList.selectedOptions).forEach(opt => selectedItems.push(opt.value)); renderSelected(); }
        function removeSelected() { /* ... remove items based on dataset.index ... */
            const indicesToRemoveInView = Array.from(selList.selectedOptions).map(opt => parseInt(opt.dataset.index, 10)).filter(index => !isNaN(index)); if (indicesToRemoveInView.length === 0) return;
            const newSelectedItems = []; for (let i = 0; i < selectedItems.length; i++) { if (!indicesToRemoveInView.includes(i)) { newSelectedItems.push(selectedItems[i]); } } selectedItems = newSelectedItems; renderSelected(); }
        function clearSelected() { selectedItems = []; renderSelected(); }
        populateAvailable(); filterInput.addEventListener('input', populateAvailable); addBtn.addEventListener('click', addSelected); remBtn.addEventListener('click', removeSelected); clearBtn.addEventListener('click', clearSelected);
        selList.addEventListener('keydown', e => { if (e.key === 'Delete' || e.key === 'Backspace') { e.preventDefault(); removeSelected(); } }); selList.addEventListener('dblclick', removeSelected); availList.addEventListener('dblclick', addSelected);
        return { getSelectedItems: () => selectedItems, clear: clearSelected };
    }

    // --- Condensing Logic (unchanged) ---
    function getPartId(code) { /* ... getPartId unchanged ... */ const match = code.match(/\{(\d+)/); return match ? match[1] : null; }
    function condenseParts(parts) { /* ... condenseParts unchanged ... */
         if (!parts || parts.length === 0) return []; const grouped = {}; const individualParts = [];
         parts.forEach(code => { const match = code.match(/^\{(\d+)(:\s*([^}\[\]]+)|:\s*\[([^\]]+)\])?\s*\}$/); if (match) { const id = match[1]; if (!grouped[id]) grouped[id] = []; grouped[id].push(code.trim()); } else if (typeof code === 'string' && code.trim().length > 0 && !code.includes('||')) { individualParts.push(code.trim()); } });
         const condensedParts = [];
         for (const id in grouped) { const codes = grouped[id]; if (codes.length === 1) { condensedParts.push(codes[0]); } else { let values = []; let isSimpleIdOnly = true; codes.forEach(code => { const valueMatch = code.match(/:\s*([^}\[\]]+)\s*\}$/); const arrayMatch = code.match(/:\s*\[([^\]]+)\]\s*\}$/); const simpleIdMatch = code.match(/^\{(\d+)\}$/); if (arrayMatch) { values.push(...arrayMatch[1].trim().split(/\s+/).filter(v => v)); isSimpleIdOnly = false; } else if (valueMatch) { values.push(valueMatch[1].trim()); isSimpleIdOnly = false; } else if (!simpleIdMatch) { individualParts.push(code); } }); if (isSimpleIdOnly && codes.length > 0) { condensedParts.push(codes[0]); } else if (values.length > 0) { const uniqueValues = [...new Set(values)]; if (uniqueValues.length === 1 && codes.length > 1) { condensedParts.push(`{${id}:[${uniqueValues[0]}]}`); } else if (uniqueValues.length > 0) { condensedParts.push(`{${id}:[${uniqueValues.join(' ')}]}`); } else if (codes.length > 0) { condensedParts.push(codes[0]); } } else if (codes.length > 0 && !isSimpleIdOnly) { condensedParts.push(codes[0]); } } }
         return [...condensedParts, ...individualParts]; }

    // --- Output Rebuilding (unchanged logic) ---
    function rebuildOutput() { /* ... rebuildOutput unchanged ... */
        try { rndSeed = Math.floor(1000 + Math.random() * 9000); const allSelectedParts = []; const baseInput = dom.inputSerialCode.textContent.trim(); let header = ''; let dynamicParts = [];
            if (baseInput) { const headerMatch = baseInput.match(/^([^\{]*\|\|\s*)/); if (headerMatch) { header = headerMatch[0].trim(); const remaining = baseInput.substring(headerMatch[0].length).trim(); dynamicParts = remaining ? remaining.split(/\s+/).filter(p => p.length > 0) : []; } else { const firstBlockIndex = baseInput.indexOf('{'); if (firstBlockIndex === 0) { header = ''; dynamicParts = baseInput.split(/\s+/).filter(p => p.length > 0); } else if (firstBlockIndex > 0) { header = baseInput.substring(0, firstBlockIndex).trim(); dynamicParts = baseInput.substring(firstBlockIndex).trim().split(/\s+/).filter(p => p.length > 0); } else { header = baseInput; dynamicParts = []; } } if (header) allSelectedParts.push(header); allSelectedParts.push(...dynamicParts); }
            else { const typeMap = { gun: 1, shield: 2, grenade: 3, classmod: 4, enhancement: 5 }; const itemTypeId = typeMap[dom.itemTypeSel.value] || 0; header = `${itemTypeId}, 0, 1, 50| 2, ${rndSeed}||`; allSelectedParts.push(header); const rarityCodeMap = { common: 217, uncommon: 218, rare: 219, epic: 220, legendary: 999 }; const rarityPart = `{${rarityCodeMap[dom.raritySel.value] || 0}}`; allSelectedParts.push(rarityPart); }
            Object.values(builders).forEach(builder => { if (typeof builder.getSelectedItems === 'function') { allSelectedParts.push(...builder.getSelectedItems()); } });
            const identifiedHeader = allSelectedParts[0].includes('||') ? allSelectedParts[0].trim() : ''; const partsToProcess = identifiedHeader ? allSelectedParts.slice(1) : allSelectedParts; const condensedDynamicParts = condenseParts(partsToProcess); const finalParts = []; if (identifiedHeader) finalParts.push(identifiedHeader); finalParts.push(...condensedDynamicParts); let newOutput = finalParts.join(' ').trim(); if (condensedDynamicParts.length > 0 && !newOutput.endsWith('|')) { newOutput += '|'; } else if (!identifiedHeader && condensedDynamicParts.length > 0 && !newOutput.endsWith('|')) { newOutput += '|'; } newOutput = newOutput.replace(/\s{2,}/g, ' '); lastGeneratedOutput = newOutput;
            if (document.activeElement !== dom.outCode) { dom.outCode.textContent = newOutput; if (isManualEditMode) { isManualEditMode = false; dom.outCode.classList.remove('manual-edit'); dom.outWrapper.classList.remove('manual-edit'); dom.outWrapper.querySelector('.manual-edit-indicator').style.display = 'none'; } }
        } catch (err) { showMessage(`Error generating output: <code>${err.message}</code>. Check builder setup and data.`, 'error'); console.error("Output Generation Error:", err); dom.outCode.textContent = '[Error generating output]'; lastGeneratedOutput = ''; }
    }

    // --- Debounced Triggers (unchanged) ---
    function triggerDebouncedRebuild() { /* ... unchanged ... */ clearTimeout(rebuildTimer); rebuildTimer = setTimeout(rebuildOutputAndCallApi, 50); }
    function triggerDebouncedApiCall() { /* ... unchanged ... */ clearTimeout(apiCallTimer); if (!isManualEditMode) { apiCallTimer = setTimeout(callReserialize, 400); } }
    function rebuildOutputAndCallApi() { /* ... unchanged ... */ rebuildOutput(); triggerDebouncedApiCall(); }

    // --- API Logic (MODIFIED for Loading/Toast) ---
    async function callReserialize() {
        if (dom.serial_b85) dom.serial_b85.textContent = 'Fetching...';
        if (dom.additionalData) dom.additionalData.textContent = '';
        dom.copySerial.disabled = true;
        showLoading(true); // *** NEW: Show loader ***

        try {
            const outText = (dom.outCode?.textContent || '').trim();

            if (!outText || outText === '[Error generating output]' || !outText.endsWith('|')) {
                if (dom.serial_b85) dom.serial_b85.textContent = '[No valid serial to send]';
                // *** NEW: Show info toast instead of error ***
                showMessage('No valid serial to send to API', 'info');
                return; // Exit early
            }

            const resp = await fetch('https://borderlands4-deserializer.nicnl.com/api/v1/reserialize', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ deserialized: outText })
            });

            if (!resp.ok) {
                let errorText = `HTTP ${resp.status} - ${resp.statusText}`;
                try { const errorData = await resp.json(); errorText += `: ${errorData.error || errorData.message || 'Unknown API error'}`; }
                catch (_) {}
                throw new Error(errorText);
            }

            const data = await resp.json();
            if (dom.serial_b85) dom.serial_b85.textContent = data.serial_b85 || '[No serial returned]';
            if (dom.additionalData) dom.additionalData.textContent = data.additional_data || '[No details]';
            dom.copySerial.disabled = !data.serial_b85;
             // *** NEW: Optional success message ***
             // showMessage('Serial validated successfully!', 'success', 2000); // Short duration success

        } catch (err) {
            console.error('Reserialize API error:', err);
            if (dom.serial_b85) dom.serial_b85.textContent = `[API error: ${err.message}]`;
            if (dom.additionalData) dom.additionalData.textContent = '';
            dom.copySerial.disabled = true;
            if (!err.message.includes('aborted')) {
                 // *** NEW: Show error toast ***
                 showMessage(`API Error: ${err.message}`, 'error');
            }
        } finally {
             showLoading(false); // *** NEW: Hide loader ***
        }
    }

    // --- Initialization (MODIFIED to call setupCollapsibleSections) ---
    async function initializeApp() {
        dom.body.classList.add('loading');
        try {
            // Fetch and parse data
            const response = await fetch('bl4_parts_data.json');
            if (!response.ok) throw new Error(`HTTP error ${response.status} fetching <code>bl4_parts_data.json</code>.`);
            try { PAYLOAD = await response.json(); }
            catch (jsonError) { throw new Error(`Failed to parse <code>bl4_parts_data.json</code>: ${jsonError.message}.`); }

            // Validate data
            const requiredKeys = ['altFireModes', 'magazineModes', 'legendaryPerks', 'ordnancePerks'];
            const missingKeys = requiredKeys.filter(key => !PAYLOAD[key] || !Array.isArray(PAYLOAD[key]));
            if (missingKeys.length > 0) throw new Error(`Data Validation Error: Key(s) <code>${missingKeys.join(', ')}</code> missing/invalid in JSON.`);

            // Initialize builders
            document.querySelectorAll('.builderSection').forEach(section => {
                 const key = section.dataset.key;
                 const nameField = section.dataset.nameField;
                 const codeField = section.dataset.codeField;
                 const idPrefix = section.dataset.idPrefix;
                 if (key && nameField && codeField && idPrefix && PAYLOAD[key]) {
                     try { builders[key] = createBuilder(key, nameField, codeField, idPrefix); }
                     catch (builderError) { throw new Error(`Failed to init builder for ${key}: ${builderError.message}`); }
                 } else { console.warn("Skipping builder section, missing data or attributes:", section, key); }
            });

            // --- Setup Event Listeners ---
            dom.itemTypeSel.addEventListener('change', triggerDebouncedRebuild);
            dom.raritySel.addEventListener('change', triggerDebouncedRebuild);
            dom.dice.onclick = () => { rndSeed = Math.floor(1000 + Math.random()*9000); triggerDebouncedRebuild(); };
            dom.inputSerialCode.addEventListener('input', () => {
                 clearTimeout(rebuildTimer);
                 rebuildTimer = setTimeout(rebuildOutputAndCallApi, 50);
             });
            dom.outCode.addEventListener('input', () => { /* ... manual edit logic ... */
                isManualEditMode = true; dom.outCode.classList.add('manual-edit'); dom.outWrapper.classList.add('manual-edit');
                dom.outWrapper.querySelector('.manual-edit-indicator').style.display = 'inline'; clearTimeout(apiCallTimer); });
            dom.undoEditBtn.addEventListener('click', () => { /* ... undo logic ... */
                if (lastGeneratedOutput) { dom.outCode.textContent = lastGeneratedOutput; isManualEditMode = false; dom.outCode.classList.remove('manual-edit'); dom.outWrapper.classList.remove('manual-edit'); dom.outWrapper.querySelector('.manual-edit-indicator').style.display = 'none'; triggerDebouncedApiCall(); showCopyStatus(dom.copyFullStatus, 'Edit Undone'); } else { showCopyStatus(dom.copyFullStatus, 'No history!'); } });
            dom.reserializeManualBtn.addEventListener('click', callReserialize);
             dom.copyFull.addEventListener('click', async () => { /* ... copy logic (MODIFIED for toast) ... */
                try { const text = (dom.outCode?.textContent || '').trim(); if (!text || text.startsWith('[')) return showMessage('No output to copy!', 'error'); await navigator.clipboard.writeText(text); showMessage('Output copied!', 'success'); } catch(e) { console.error('Copy Output failed:', e); showMessage('Copy failed!', 'error'); } });
             dom.copySerial.addEventListener('click', async () => { /* ... copy logic (MODIFIED for toast) ... */
                try { const text = (dom.serial_b85?.textContent || '').trim(); if (!text || text.startsWith('[')) return showMessage('No API serial to copy!', 'error'); await navigator.clipboard.writeText(text); showMessage('API serial copied!', 'success'); } catch(e) { console.error('Copy API Serial failed:', e); showMessage('Copy failed!', 'error'); } });

             // *** Setup Collapsible Sections ***
             setupCollapsibleSections();

            // Initial build and API call
            rebuildOutput();
            setTimeout(callReserialize, 150);
            // dom.messageArea.style.display = 'none'; // Keep fallback hidden initially

        } catch (error) {
            showMessage(error.message, 'error', 10000); // Show init errors longer
             // Disable interactive elements on critical init error
             document.querySelectorAll('input, select, button, [contenteditable]').forEach(el => el.disabled = true);
             if (dom.inputSerialCode) dom.inputSerialCode.contentEditable = false;
             if (dom.outCode) dom.outCode.contentEditable = false;
        } finally {
             dom.body.classList.remove('loading');
             showLoading(false); // Ensure loader is hidden even if init fails
        }
    }

    // Start the app
    document.addEventListener('DOMContentLoaded', initializeApp);

</script>
</body>
</html>

