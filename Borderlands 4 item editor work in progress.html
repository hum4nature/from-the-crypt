<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Borderlands 4 Serial Editor & Decoder</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for dark theme and layout */
        body {
            font-family: 'Inter', sans-serif; /* Using Inter font */
            background-color: #1a202c; /* Dark background */
            color: #e2e8f0; /* Light text */
        }
        .card {
            background-color: #2d3748; /* Slightly lighter card background */
            border-radius: 0.75rem; /* Rounded corners */
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid #4a5568;
        }
        .output-section, .editor-section {
            background-color: #2d3748;
            border: 1px solid #4a5568;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
            overflow-x: auto; /* Allow horizontal scroll for tables if needed */
        }
        label {
            display: block;
            margin-bottom: 0.5rem;
            color: #a0aec0; /* Lighter label text */
            font-size: 0.875rem; /* Smaller labels */
        }
        input[type="text"], input[type="number"], textarea, select {
            background-color: #1a202c;
            border: 1px solid #4a5568;
            color: #e2e8f0;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            width: 100%;
            margin-bottom: 0.75rem; /* Add spacing */
             /* Attempt to manage potential overflow causing width issues */
             white-space: nowrap;
             overflow: hidden;
             text-overflow: ellipsis;
        }
        select {
             height: 2.5rem; /* Consistent height */
             /* Appearance reset might help with consistency */
             appearance: none;
             -webkit-appearance: none;
             -moz-appearance: none;
             background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="%23a0aec0" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/></svg>');
             background-repeat: no-repeat;
             background-position: right 0.5rem center;
             background-size: 1em;
             padding-right: 2rem; /* Make space for arrow */
        }
         /* Style for the code output blocks */
        code[contenteditable="true"], code#apiSerialOutput {
            display: block;
            background:#0c121b;
            border:1px solid #1f2a3a;
            padding:10px 12px;
            border-radius:10px;
            font-family: monospace;
            color: #9ae6b4; /* Light green for code */
            min-height: 60px; /* Give it some initial height */
            white-space: pre-wrap; /* Allow wrapping */
            word-break: break-all;
            margin-bottom: 1rem;
        }
        /* CSS Placeholder for contenteditable */
        code[contenteditable="true"]:empty::before {
            content: attr(data-placeholder);
            color: #a0aec0; /* Muted placeholder color */
            pointer-events: none; /* Make it non-interactive */
            display: block; /* Ensures it takes up space */
        }
        /* Hide placeholder on focus, even if empty */
        code[contenteditable="true"]:focus::before {
            content: "";
        }
         /* Style specifically for non-editable code output */
         code#apiSerialOutput {
             color: #e2e8f0; /* Use standard text color */
             background: #1a202c; /* Match input background */
             min-height: 0; /* API output can be small */
             margin-bottom: 0; /* No margin for API output */
         }
         /* Details box styling */
         #detailsOutput {
             background: #1a202c;
             border: 1px solid #4a5568;
             border-radius: 0.375rem;
             padding: 0.5rem 0.75rem;
             min-height: 60px;
             font-family: monospace;
             font-size: 0.875rem;
             color: #a0aec0;
             white-space: pre-wrap;
             word-break: break-all;
         }

        button {
            background-color: #4a5f7b;
            color: white;
            padding: 0.6rem 1.2rem;
            border-radius: 0.375rem;
            transition: all 0.2s ease-in-out;
            border: none;
            cursor: pointer;
            font-weight: 500;
            /* display: block;  Let buttons size naturally in flex */
            /* width: 100%; */
            margin-top: 0.5rem; /* Add space above button */
        }
        button:hover {
            background-color: #2c3a4f;
            transform: translateY(-1px); /* Slight lift on hover */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
         /* Small button style */
         button.small {
             padding: 6px 10px;
             border-radius: 8px;
             margin-top: 0; /* Override default margin */
             margin-left: 0.5rem; /* Space between buttons */
         }

        /* Style for the main decode/generate button */
        .action-button {
             background-image: linear-gradient(to right, #4f46e5, #7c3aed); /* Gradient */
             font-weight: 600;
             padding: 0.75rem 1.5rem;
             box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
             display: inline-block; /* Allow side-by-side */
             width: auto; /* Reset width */
             margin-top: 0; /* Reset margin */
        }
        .action-button:hover {
            background-image: linear-gradient(to right, #4338ca, #6d28d9);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transform: translateY(-2px);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        th, td {
            border: 1px solid #4a5568;
            padding: 0.5rem 0.75rem;
            text-align: left;
            vertical-align: top;
        }
        th {
            background-color: #2c3a4f;
            color: #cbd5e0;
        }
        /* Code within regular text or tables */
        td code, p code, li code:not([contenteditable="true"]):not(#apiSerialOutput) {
            background-color: #1a202c;
            padding: 0.1rem 0.3rem;
            border-radius: 0.25rem;
            font-family: monospace;
            color: #9ae6b4; /* Light green for code */
            word-break: break-all;
        }
        .part-details { margin-left: 1rem; color: #a0aec0; font-size: 0.9em;}
        .array-item { margin-left: 2rem; }
        .error-message { color: #f56565; margin-top: 0.5rem; min-height: 1.25rem; /* Prevent layout shift */}
        .control-group label { display: inline-flex; align-items: center; margin-right: 1rem; cursor: pointer; }
        .control-group input[type="checkbox"] { margin-right: 0.5rem; }
        .editor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); /* Wider columns */
            gap: 1.5rem; /* Increased gap */
        }
        .part-selector {
             background-color: #1a202c;
             padding: 1rem;
             border-radius: 0.5rem;
             border: 1px solid #4a5568;
             display: flex;
             flex-direction: column;
        }
        .part-selector label {
            margin-bottom: 0.5rem; /* Ensure space below label */
        }
        .part-selector select {
            margin-bottom: 0.75rem; /* Space below select */
            flex-grow: 1; /* Allow select to grow if needed */
        }
        .part-selector button {
             margin-top: auto; /* Push button to bottom */
             width: 100%; /* Ensure button takes full width */
        }

        .current-parts-list {
            list-style: none;
            padding: 0;
            margin-top: 0.5rem;
            max-height: 200px; /* Increased height */
            overflow-y: auto;
            background-color: #1a202c;
            border: 1px solid #4a5568;
            border-radius: 0.375rem;
            padding: 0.5rem;
        }
        .current-parts-list li {
            background-color: #2d3748;
            padding: 0.25rem 0.5rem;
            margin-bottom: 0.25rem;
            border-radius: 0.25rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.875rem;
        }
         .current-parts-list code {
             margin-right: 0.5rem; /* Space between code and buttons */
             white-space: nowrap; /* Prevent code wrapping */
             overflow: hidden;
             text-overflow: ellipsis; /* Add ellipsis if too long */
             flex-grow: 1; /* Allow code to take up space */
             background: transparent; /* Override default code background */
             padding: 0;
             border: none;
             color: inherit;
         }
        .list-button { /* Common style for list buttons */
            padding: 0.1rem 0.4rem;
            font-size: 0.75rem;
            border-radius: 9999px; /* Circle */
            width: auto; /* Override block width */
            margin-top: 0; /* Override margin */
            margin-left: 0.25rem; /* Space between buttons */
            flex-shrink: 0; /* Prevent button shrinking */
        }
        .remove-button { background-color: #e53e3e; /* Red */ }
        .remove-button:hover { background-color: #c53030; }
        .copy-button { background-color: #4299e1; /* Blue */ }
        .copy-button:hover { background-color: #2b6cb0; }
        .copy-feedback {
            position: fixed;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: #48bb78; /* Green */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            z-index: 100;
        }
        .copy-feedback.show { opacity: 1; }

         /* Styles for API/Details sections */
         .api-details-grid {
             display: grid;
             grid-template-columns: 1fr; /* Stack on small screens */
             gap: 1.5rem;
             margin-top: 1.5rem;
         }
         @media (min-width: 768px) { /* Side-by-side on medium screens and up */
             .api-details-grid {
                 grid-template-columns: repeat(2, 1fr);
             }
         }
         #detailsOutput ul { list-style: disc; padding-left: 1.5rem; }
         #detailsOutput li { margin-bottom: 0.25rem; }
         #detailsOutput strong { color: #a0aec0; }

    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="p-4 md:p-8">

    <h1 class="text-3xl font-bold mb-6 text-center text-white">Borderlands 4 Serial Editor & Decoder</h1>

    <!-- Serial Input / Output & Decoder Controls -->
    <div class="card">
        <!-- Replaced Textarea with Code block -->
        <div class="mb-4">
             <label for="serialOutputCode" class="font-semibold text-lg mb-2">Output / Edit Serial Code:</label>
             <!-- Added data-placeholder and removed default text -->
             <code id="serialOutputCode" contenteditable="true" spellcheck="false" data-placeholder="Select Base Item below and add parts, then click Generate... Or paste a code here."></code>
             <button id="copyOutputBtn" class="small mt-1">Copy Output</button>
        </div>

        <div class="mb-4 control-group grid grid-cols-2 md:grid-cols-4 gap-2 text-sm">
             <label><input type="checkbox" id="ctrlShowTable" checked> Show Table</label>
             <label><input type="checkbox" id="ctrlShowSummary" checked> Show Summary</label>
        </div>

        <button id="decodeButton" class="action-button">Decode Serial</button>
        <div id="errorMessage" class="error-message mt-4"></div>

        <!-- API Sections -->
        <div class="api-details-grid">
            <div class="editor-section">
                <div class="flex justify-between items-center mb-2">
                    <label for="apiSerialOutput" class="font-semibold text-lg !mb-0">New Serial (from API):</label>
                    <button id="copyApiBtn" class="small">Copy Serial</button>
                </div>
                 <code id="apiSerialOutput" aria-live="polite">Waiting for input...</code>
            </div>
            <div id="detailsOutputContainer" class="editor-section">
                <label for="detailsOutput" class="font-semibold text-lg mb-2">Details (from API):</label>
                <!-- Changed to div for rich text from API -->
                <div id="detailsOutput" aria-live="polite">Waiting for input...</div>
            </div>
        </div>
    </div>


    <!-- Serial Editor Section -->
    <div class="card">
        <h2 class="text-2xl font-semibold mb-4 border-b border-gray-600 pb-2">Serial Editor</h2>

        <!-- Base Item Selection -->
        <div class="editor-section mb-4">
            <h3 class="text-xl font-semibold mb-3">Base Item</h3>
            <div>
                <label for="selectBaseItem">Select Base Item Type:</label>
                <select id="selectBaseItem">
                    <option value="" disabled selected>Choose item type...</option>
                    <!-- Options will be populated by JavaScript -->
                </select>
            </div>
             <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
                 <div>
                    <label for="editLevel">Item Level:</label>
                    <input type="number" id="editLevel" value="50" placeholder="e.g., 50">
                </div>
                 <div>
                    <label for="editRarityPart">Rarity Part:</label>
                    <select id="editRarityPart">
                         <option value="{95}">Common {95}</option>
                         <option value="{96}">Uncommon {96}</option>
                         <option value="{97}">Rare {97}</option>
                         <option value="{98}" selected>Epic {98}</option>
                         <option value="{??}">Legendary {??}</option> <!-- Placeholder -->
                    </select>
                 </div>
            </div>
        </div>

        <!-- Body Parts Editor -->
        <div class="editor-section mb-4">
            <h3 class="text-xl font-semibold mb-3">Add Body Parts</h3>
             <div class="editor-grid">
                 <!-- Barrel -->
                 <div class="part-selector">
                     <label for="selectBarrel">Barrel:</label>
                     <select id="selectBarrel">
                         <option value="" disabled selected>Select barrel...</option>
                         <!-- Populated by JS based on Base Item -->
                     </select>
                     <button onclick="addPart('selectBarrel')">Add Barrel</button>
                 </div>
                 <!-- Magazine (Includes Ammo-related Alt Fires) -->
                 <div class="part-selector">
                     <label for="selectMagazine">Magazine / Ammo Mode:</label>
                     <select id="selectMagazine">
                         <option value="" disabled selected>Select magazine...</option>
                         <!-- Populated by JS -->
                     </select>
                     <button onclick="addPart('selectMagazine')">Add Magazine/Mode</button>
                 </div>
                  <!-- Scope/Sight -->
                 <div class="part-selector">
                     <label for="selectScope">Scope/Sight:</label>
                     <select id="selectScope">
                         <option value="" disabled selected>Select scope...</option>
                         <!-- Populated by JS -->
                     </select>
                     <button onclick="addPart('selectScope')">Add Scope</button>
                 </div>
                 <!-- Element -->
                 <div class="part-selector">
                     <label for="selectElement">Element:</label>
                     <select id="selectElement">
                         <option value="" disabled selected>Select element...</option>
                         <!-- Populated by JS -->
                     </select>
                     <button onclick="addPart('selectElement')">Add Element</button>
                 </div>
                 <!-- ALT Fire Mode (Excludes Ammo modes) -->
                 <div class="part-selector">
                     <label for="selectAltFire">ALT Fire Mode:</label>
                     <select id="selectAltFire">
                         <option value="" disabled selected>Select alt fire...</option>
                         <!-- Populated by JS -->
                     </select>
                     <button onclick="addPart('selectAltFire')">Add Alt Fire</button>
                 </div>
                 <!-- Legendary Perk Part -->
                 <div class="part-selector">
                     <label for="selectLegendaryPerk">Legendary Perk Part:</label>
                     <select id="selectLegendaryPerk">
                         <option value="" disabled selected>Select perk part...</option>
                         <!-- Populated by JS -->
                     </select>
                     <button onclick="addPart('selectLegendaryPerk')">Add Perk Part</button>
                 </div>
                 <!-- Ordnance Legendary Perks (Replaces Generic Accessory) -->
                 <div class="part-selector">
                     <label for="selectOrdnancePerk">Ordnance Legendary Perks:</label>
                     <select id="selectOrdnancePerk"> <!-- Changed ID -->
                         <option value="" disabled selected>Select ordnance perk...</option> <!-- Updated Placeholder -->
                         <!-- Populated by JS -->
                     </select>
                     <button onclick="addPart('selectOrdnancePerk')">Add Ordnance Perk</button> <!-- Updated onclick target -->
                 </div>

                 <!-- Array Parts (Enhancements) -->
                 <div class="part-selector">
                    <label for="selectArraySetId">Enhancement Set ID:</label>
                     <select id="selectArraySetId">
                         <option value="" disabled selected>Select Set ID...</option>
                         <!-- Placeholder options -->
                         <option value="27">Jakobs AR Set {27}</option>
                         <option value="245">Generic Stat Set {245}</option>
                         <option value="237">Armor Stat Set {237}</option>
                         <option value="248">Energy Stat Set {248}</option>
                         <!-- Add more based on Enhancement data -->
                     </select>
                     <label for="selectArrayValue">Enhancement Value:</label>
                     <select id="selectArrayValue">
                         <option value="" disabled selected>Select Stat...</option>
                          <!-- Placeholder options -->
                          <option value="15">Enhancement A {15} (+Dmg?)</option>
                         <option value="75">Enhancement B {75} (+Acc?)</option>
                         <option value="55">Enhancement C {55} (+Crit?)</option>
                         <!-- Add more based on Enhancement data -->
                     </select>
                    <button onclick="addArrayPart()">Add Enhancement</button>
                 </div>

            </div>
        </div>

        <!-- Current Parts & Generation -->
        <div class="editor-section">
             <h3 class="text-xl font-semibold mb-2">Currently Building:</h3>
             <ul id="currentPartsList" class="current-parts-list mb-4">
                 <!-- Parts will be added here -->
             </ul>
             <button id="generateButton" class="action-button">Generate Serial String</button>
        </div>

    </div>

    <!-- Decoder Output Area -->
    <div id="outputContainer">
        <!-- Output sections will be dynamically populated here -->
         <div id="headerOutput" class="output-section hidden">
            <h2 class="text-xl font-semibold mb-2 border-b border-gray-600 pb-1">1. Header Information (Item Meta)</h2>
            <div id="headerContent"></div>
        </div>
        <div id="blocksOutput" class="output-section hidden">
            <h2 class="text-xl font-semibold mb-2 border-b border-gray-600 pb-1">2 & 3. Top-Level & Array Blocks</h2>
            <div id="blocksContent"></div>
        </div>
         <div id="summaryOutput" class="output-section hidden">
             <h2 class="text-xl font-semibold mb-2 border-b border-gray-600 pb-1">4. Summary Interpretation</h2>
            <p id="summaryContent"></p>
        </div>
        <div id="tableOutput" class="output-section hidden">
             <h2 class="text-xl font-semibold mb-2 border-b border-gray-600 pb-1">5. Table Output</h2>
            <table id="dataTable" class="text-sm">
                <thead>
                    <tr>
                        <th>Category</th>
                        <th>ID</th>
                        <th>Part/Stat Name</th>
                        <th>Function / Effect</th>
                        <th>Stack Count</th>
                        <th>Source Reference</th>
                    </tr>
                </thead>
                <tbody id="dataTableBody">
                </tbody>
            </table>
        </div>
    </div>

    <!-- Copy Feedback Element -->
    <div id="copyFeedback" class="copy-feedback">Copied to clipboard!</div>

    <script>
        // Define lookup tables in the global scope first
        // These will be populated by the IIFE
        let genericParts = {30:{name:"Core Component",func:"Body/Stat Block"},14:{name:"Magazine", func:"Ammo/Reload"},19:{name:"Muzzle", func:"Barrel Mod"},21:{name:"Optics", func:"Sight/Scope"}};
        let specificParts = {};
        let arrayParts = {'27:15':{name:"AR Stat A",func:"+Dmg?"},'27:75':{name:"AR Stat B", func:"+Acc?"},'245:55':{name:"Crit Boost", func:"+Crit"},'default':{name:"Enhancement Stat",func:"Stat Bonus"}};

        // --- Placeholder Data & Lookup Functions ---
        // Basic structure - ideally load this from external JSON/CSV in a real app
        // FULL list from The Editor 2.0 (2).txt
        const BASE_ITEMS = [
             { id: 2, name: "Daedalus Pistol", mfr: "Daedalus", type: "Pistol" },
             { id: 3, name: "Jakobs Pistol", mfr: "Jakobs", type: "Pistol" },
             { id: 4, name: "Order Pistol", mfr: "Order", type: "Pistol" },
             { id: 5, name: "Tediore Pistol", mfr: "Tediore", type: "Pistol" },
             { id: 6, name: "Torgue Pistol", mfr: "Torgue", type: "Pistol" },
             { id: 7, name: "Ripper Shotgun", mfr: "Ripper", type: "Shotgun" },
             { id: 8, name: "Daedalus Shotgun", mfr: "Daedalus", type: "Shotgun" },
             { id: 9, name: "Jakobs Shotgun", mfr: "Jakobs", type: "Shotgun" },
             { id: 10, name: "Maliwan Shotgun", mfr: "Maliwan", type: "Shotgun" },
             { id: 11, name: "Tediore Shotgun", mfr: "Tediore", type: "Shotgun" },
             { id: 12, name: "Torgue Shotgun", mfr: "Torgue", type: "Shotgun" },
             { id: 13, name: "Daedalus Assault Rifle", mfr: "Daedalus", type: "Assault Rifle" },
             { id: 14, name: "Tediore Assault Rifle", mfr: "Tediore", type: "Assault Rifle" },
             { id: 15, name: "Order Assault Rifle", mfr: "Order", type: "Assault Rifle" },
             { id: 16, name: "Vladof Sniper", mfr: "Vladof", type: "Sniper" },
             { id: 17, name: "Torgue Assault Rifle", mfr: "Torgue", type: "Assault Rifle" },
             { id: 18, name: "Vladof Assault Rifle", mfr: "Vladof", type: "Assault Rifle" },
             { id: 19, name: "Ripper SMG", mfr: "Ripper", type: "SMG" },
             { id: 20, name: "Daedalus SMG", mfr: "Daedalus", type: "SMG" },
             { id: 21, name: "Maliwan SMG", mfr: "Maliwan", type: "SMG" },
             { id: 22, name: "Vladof SMG", mfr: "Vladof", type: "SMG" },
             { id: 23, name: "Ripper Sniper", mfr: "Ripper", type: "Sniper" },
             { id: 24, name: "Jakobs Sniper", mfr: "Jakobs", type: "Sniper" },
             { id: 25, name: "Maliwan Sniper", mfr: "Maliwan", type: "Sniper" },
             { id: 26, name: "Order Sniper", mfr: "Order", type: "Sniper" },
             { id: 27, name: "Jakobs Assault Rifle", mfr: "Jakobs", type: "Assault Rifle" },
             { id: 254, name: "Siren Class Mod", mfr: "Siren", type: "Class Mod" },
             { id: 255, name: "Forgeknight Class Mod", mfr: "Forgeknight", type: "Class Mod" },
             { id: 256, name: "EXO Soldier Class Mod", mfr: "EXO Soldier", type: "Class Mod" },
             { id: 259, name: "Gravitar Class Mod", mfr: "Gravitar", type: "Class Mod" },
             { id: 261, name: "Torgue Repair Kit", mfr: "Torgue", type: "Repair Kit" },
             { id: 263, name: "Maliwan Gadget", mfr: "Maliwan", type: "Gadget" },
             { id: 264, name: "Hyperion Enhancement", mfr: "Hyperion", type: "Enhancement" },
             { id: 265, name: "Jakobs Repair Kit", mfr: "Jakobs", type: "Repair Kit" },
             { id: 266, name: "Maliwan Repair Kit", mfr: "Maliwan", type: "Repair Kit" },
             { id: 267, name: "Jakobs Gadget", mfr: "Jakobs", type: "Gadget" },
             { id: 270, name: "Daedalus Gadget", mfr: "Daedalus", type: "Gadget" },
             { id: 272, name: "Order Gadget", mfr: "Order", type: "Gadget" },
             { id: 273, name: "Torgue Heavy Ordnance", mfr: "Torgue", type: "Heavy Weapon" },
             { id: 275, name: "Ripper Heavy Weapon", mfr: "Ripper", type: "Heavy Weapon" },
             { id: 278, name: "Ripper Gadget", mfr: "Ripper", type: "Gadget" },
             { id: 279, name: "Maliwan Shield", mfr: "Maliwan", type: "Shield" },
             { id: 282, name: "Vladof Heavy Weapon", mfr: "Vladof", type: "Heavy Weapon" },
             { id: 291, name: "Vladof Grenade", mfr: "Vladof", type: "Grenade" },
             { id: 298, name: "Torgue Grenade", mfr: "Torgue", type: "Grenade" },
             { id: 311, name: "Atlas Grenade", mfr: "Atlas", type: "Grenade" },
             // Other sets
             { id: 245, name: "Generic Stat Set", mfr: "Various", type: "Enhancement" },
             { id: 237, name: "Armor Stat Set", mfr: "Various", type: "Enhancement" },
             { id: 248, name: "Energy Stat Set", mfr: "Various", type: "Enhancement" },
         ];

        // Refactored IIFE to populate global vars and return dropdown data
        const PARTS_DATA = (function(globalGenericParts, globalSpecificParts) {
            let dataStructure = {
                common: {
                    elements: [
                        { value: "{1:10}", text: "Corrosive {1:10}" }, { value: "{1:11}", text: "Cryo {1:11}" },
                        { value: "{1:12}", text: "Incendiary {1:12}" }, { value: "{1:13}", text: "Radiation {1:13}" },
                        { value: "{1:14}", text: "Shock {1:14}" }, { value: "{1:19}", text: "Cryo/Incendiary {1:19}" },
                        { value: "{1:24}", text: "Cryo/Corrosive {1:24}" },
                    ],
                    scopes: [
                        { value: "{26}", text: "Iron Sights {26}" }, { value: "{27}", text: "Reflex Sight {27}" },
                        { value: "{28}", text: "Holo Sight {28}" }, { value: "{29}", text: "ACOG Scope {29}" },
                        { value: "{30}", text: "Sniper Scope {30}" },
                    ],
                    altFireModes: [], magazineModes: [], legendaryPerks: [], ordnancePerks: [] // Initialize arrays
                },
                9: { // Jakobs Shotgun Example
                    barrels: [ { value: "{7}", text: "Barrel - Dullahan {7}" }, { value: "{8}", text: "Barrel - Balor {8}" }, { value: "{90}", text: "Barrel - TK's Wave {90}" }, ],
                },
                13: { // Daedalus Assault Rifle Example
                    barrels: [ { value: "{6}", text: "Barrel A {6}" }, { value: "{7}", text: "Barrel B {7}" }, { value: "{8}", text: "Barrel - Oscar Mike {8}" }, { value: "{57}", text: "Barrel - Lumberjack {57}" }, ],
                },
            };

            // --- Process Alt Fire Modes ---
            let altFireModesCleaned = [
                { value: "{17:45}", text: "Airstrike {17:45}" }, { value: "{5:80}", text: "Attack Drone {5:80}" },
                { value: "{25:47}", text: "Atlas Ball (Maliwan Sniper) {25:47}" }, { value: "{12:49}", text: "Atlas Ball {12:49}" },
                { value: "{12:45}", text: "Atlas {12:45}" }, { value: "{6:74}", text: "Atlas {6:74}" },
                { value: "{11:57}", text: "Auto Turret (Tediore) {11:57}" }, { value: "{10:43}", text: "Beam Toss {10:43}" },
                { value: "{7:48}", text: "Beam {7:48}" }, { value: "{6:75}", text: "Blowback {6:75}" },
                { value: "{17:44}", text: "Bounce Grenade (Torgue) {17:44}" }, { value: "{12:44}", text: "Bounce Grenade {12:44}" },
                { value: "{4:75}", text: "Bully Barrel Gun-Shield {4:75}" }, { value: "{14:64}", text: "C.O.M.B.O {14:64}" },
                { value: "{6:45}", text: "Cleaver {6:45}" }, { value: "{27:57}", text: "Crank {27:57}" },
                { value: "{2:75}", text: "Daedalus Semtex/Demo Charge {2:75}" }, { value: "{15:68}", text: "Death Sphere {15:68}" },
                { value: "{11:50}", text: "Deployable Shield {11:50}" }, { value: "{7:80}", text: "Discharge {7:80}" },
                { value: "{19:47}", text: "Drunkrocket {19:47}" }, { value: "{10:49}", text: "Energy Blast / Blowback {10:49}" },
                { value: "{4:44}", text: "Energy Burst {4:44}" }, { value: "{10:44}", text: "Energy Disk {10:44}" },
                { value: "{12:50}", text: "Flame Blast {12:50}" }, { value: "{22:52}", text: "Flame Thrower {22:52}" },
                { value: "{27:56}", text: "Flintlock {27:56}" }, { value: "{13:67}", text: "Fragcindiary {13:67}" },
                { value: "{19:46}", text: "Gastrap {19:46}" }, { value: "{7:49}", text: "Gauss {7:49}" },
                { value: "{8:43}", text: "Gravity Harpoon {8:43}" }, { value: "{9:46}", text: "Gravity Harpoon {9:46}" },
                { value: "{23:48}", text: "Gravity Trap (Ripper) {23:48}" }, { value: "{4:72}", text: "Gravity Well {4:72}" },
                { value: "{20:79}", text: "Grenade Launcher {20:79}" }, { value: "{9:45}", text: "Grenade {9:45}" },
                { value: "{27:57}", text: "Hand Crank v2 {27:57}" }, { value: "{11:79}", text: "Heavyturret {11:79}" },
                { value: "{11:70}", text: "Jacobs Ricochet Accessory {11:70}" }, { value: "{4:62}", text: "Jacobs Ricochet {4:62}" },
                { value: "{15:43}", text: "Kill Drone {15:43}" }, { value: "{9:50}", text: "Knife Launcher {9:50}" },
                { value: "{237:11}", text: "Knockback {237:11}" }, { value: "{21:53}", text: "Laser Wire {21:53}" },
                { value: "{6:44}", text: "Magnum Rockets {6:44}" }, { value: "{17:42}", text: "Malswitch {17:42}" },
                { value: "{7:53}", text: "Malswitch {7:53}" }, { value: "{23:55}", text: "Marked {23:55}" },
                { value: "{9:46}", text: "Meathook {9:46}" }, { value: "{13:62}", text: "Microrocket {13:62}" },
                { value: "{4:43}", text: "Micro Rockets {4:43}" }, { value: "{5:50}", text: "Micro Shotgun {5:50}" },
                { value: "{8:50}", text: "Mine {8:50}" }, { value: "{17:43}", text: "Mirvgrenade {17:43}" },
                { value: "{237:8}", text: "Missile Swarm {237:8}" }, { value: "{25:48}", text: "Multitaser {25:48}" },
                { value: "{20:49}", text: "Overcharge {20:49}" }, { value: "{18:6}", text: "Overdrive Shield Segment Drop (Vladof?) {18:6}" },
                { value: "{8:50}", text: "Proxy Mines v2 {8:50}" }, { value: "{7:80}", text: "Radiation Rad Fuel Rod v2 {7:80}" },
                { value: "{26:58}", text: "Railgun {26:58}" }, { value: "{21:45}", text: "Railgun V2 {21:45}" },
                { value: "{25:53}", text: "Rocketpod {25:53}" }, { value: "{5:79}", text: "Rockets {5:79}" },
                { value: "{6:44}", text: "Rockets v2 {6:44}" }, { value: "{22:55}", text: "Scrap Cannon (Vladof) {22:55}" },
                { value: "{2:74}", text: "Seeker Darts {2:74}" }, { value: "{15:42}", text: "Seeker Missile (Order) {15:42}" },
                { value: "{23:47}", text: "Seeker Missile (Ripper) {23:47}" }, { value: "{12:43}", text: "Seeker Missiles {12:43}" },
                { value: "{15:42}", text: "Seeker {15:42}" }, { value: "{25:48}", text: "Shock Field / Multi-Taser v2 {25:48}" },
                { value: "{7:48}", text: "Shock Lightning Beam v2 {7:48}" }, { value: "{13:61}", text: "Shotgun {13:61}" },
                { value: "{14:65}", text: "Shotgun v2 {14:65}" }, { value: "{27:55}", text: "Shotgun v3 {27:55}" },
                { value: "{19:52}", text: "Shrapnel (Ripper SMG) {19:52}" }, { value: "{19:52}", text: "Shrapnel {19:52}" },
                { value: "{25:49}", text: "Singularity Grenade Launcher {25:49}" }, { value: "{13:75}", text: "Spacelaser {13:75}" },
                { value: "{26:62}", text: "Spear {26:62}" }, { value: "{9:45}", text: "Spread Launcher {9:45}" },
                { value: "{237:14}", text: "Spunky {237:14}" }, { value: "{13:76}", text: "Star Helix {13:76}" },
                { value: "{11:51}", text: "Sticky Mine (Tediore) {11:51}" }, { value: "{20:79}", text: "Stungrenade {20:79}" },
                { value: "{14:68}", text: "Support Drone {14:68}" }, { value: "{22:56}", text: "Taser Housing (Vladof) {22:56}" },
                { value: "{14:10}", text: "Tedior Mirv - Splits Into 4 - {14:10}" }, { value: "{11:10}", text: "Tedior Mirv - Thorwn Gun Spawns 4 Grenades{11:10}" },
                { value: "{5:12}", text: "Tedior Replicator - Throws Gun On Reload -{5:12}" }, { value: "{2:71}", text: "Tedior Licenced-Mirv-Spawns 4 Grenades-{2:71}" },
                { value: "{26:57}", text: "Tether Snare {26:57}" }, { value: "{9:44}", text: "Tracker Darts {9:44}" },
                { value: "{6:45}", text: "Turbine Cleaver {6:45}" }, { value: "{25:53}", text: "Underbarrel Rocket Pod v2 {25:53}" },
                { value: "{3:68}", text: "Vial Launcher {3:68}" }, { value: "{3:68}", text: "Vial {3:68}" },
                { value: "{3:46}", text: "Zip Rockets {3:46}" },
            ];
            let magazineModes = [
                { value: "{17:41}", text: "Ammoswitcher {17:41}" }, { value: "{7:52}", text: "Ammoswitcher {7:52}" },
                { value: "{25:46}", text: "Ammo Switcher (Maliwan Sniper) {25:46}" }, { value: "{9:49}", text: "Ammo Switcher (Jakobs) {9:49}" },
                { value: "{10:46}", text: "Ammo Switcher (Maliwan) {10:46}" }, { value: "{12:52}", text: "Ammo SMG {12:52}" },
                { value: "{5:62}", text: "Ammo Shotgun {5:62}" }, { value: "{20:57}", text: "Ammo Sniper {20:57}" },
                { value: "{4:51}", text: "Secondary Consumes Assault Rifle Ammo {4:51}" }, { value: "{11:60}", text: "Secondary Consumes Assault Ammo {11:60}" },
                { value: "{26:68}", text: "Secondary Consumes Pistol Ammo {26:68}" }, { value: "{14:65}", text: "Secondary Consumes Shotgun Ammo {14:65}" },
                { value: "{12:51}", text: "Secondary Consumes Smg Ammo {12:51}" }, { value: "{9:54}", text: "Secondary Consumes Sniper Ammo {9:54}" },
            ];
            altFireModesCleaned.sort((a, b) => a.text.localeCompare(b.text));
            magazineModes.sort((a, b) => a.text.localeCompare(b.text));
            const standardMagazines = [
                 { value: "{13}", text: "Standard Magazine {13}"}, { value: "{14}", text: "Large Magazine {14}"},
                 { value: "{15}", text: "Alt Magazine {15}" }, { value: "{16}", text: "CoV Style Mag {16}" },
                 { value: "{17}", text: "Ripper Style Mag {17}" },
                 { value: "{2:19}", text: "Torgue Sticky Mag {2:19}"}
            ];
            const combinedMagazines = standardMagazines.concat(magazineModes);
            dataStructure.common.altFireModes = altFireModesCleaned;
            dataStructure.common.magazines = combinedMagazines;

            // --- Process Legendary Perks ---
            const processedLegendaryPerks = [
                { value: "{8:54}", text: 'Acey May "LUV" {8:54}' }, { value: "{18:4}", text: 'Aegon\'s Dream "Prophetic" {18:4}' },
                { value: "{11:75}", text: 'Anarchy "Mutualism" {11:75}' }, { value: "{25:79}", text: 'Asher\'s Rise "Slow Burn" {25:79}' },
                { value: "{24:72}", text: 'Ballista "Propagation" {24:72}' }, { value: "{22:87}", text: 'Birt\'s Bees "Hivemind" {22:87}' },
                { value: "{13:57}", text: 'Bloody Lumberjack "Timber" {13:57}' }, { value: "{8:52}", text: 'Bod "All Arounder" {8:52}' },
                { value: "{24:74}", text: 'Boomslang "Bullet Pollinator" {24:74}' }, { value: "{27:73}", text: 'Bonnie & Clyde "Pair of Thieves" {27:73}' },
                { value: "{5:59}", text: 'Budget Deity "D.O.P.E. Buoys" {5:59}' }, { value: "{17:54}", text: 'Bugbear "Rotary Gun" {17:54}' },
                { value: "{4:75}", text: 'Bully "Defense Protocal" {4:75}' },
                // { value: "{27:73}", text: 'Chaingun "Pair of Thieves" {27:73}' }, // Duplicate of Bonnie & Clyde
                { value: "{14:34}", text: 'Chuck "Pitcher" {14:34}' }, { value: "{17:55}", text: 'Cold Shoulder "Iced Out" {17:55}' },
                { value: "{25:20}", text: 'Complex Root "Sierpinski" {25:20}' }, { value: "{7:64}", text: 'Convergence "Asymptotic" {7:64}' },
                { value: "{20:64}", text: 'Darkbeast "Parley" {20:64}' }, { value: "{14:39}", text: 'Divided Focus "Conquerer" {14:39}' },
                { value: "{16:1}", text: 'Finnity XXX-L "Pipin Hot Barrels" {16:1}' }, { value: "{13:84}", text: 'First Impression "Firm Handshake" {13:84}' },
                { value: "{26:75}", text: 'Fisheye "Ultima Ratio Regum" {26:75}' }, { value: "{11:77}", text: 'Forsaken Chaos "Wide Net" {11:77}' },
                { value: "{15:2}", text: 'G.M.R "Big Name Hunter" {15:2}' }, { value: "{15:56}", text: 'Goalkeeper "Amper Camper" {15:56}' },
                { value: "{7:18}", text: 'Golden God "Rage" {7:18}' }, { value: "{7:1}", text: 'Goremaster "Chief Execution Officer" {7:1}' },
                { value: "{19:20}", text: 'Hellfire "Burning Desire" {19:20}' }, { value: "{9:82}", text: 'Hellwalker "Soothslayer" {9:82}' },
                { value: "{9:79}", text: 'Hot Slugger "Blazing Barrel" {9:79}' }, { value: "{11:79}", text: 'Husky Friend "Husky Auto Turret" {11:79}' },
                { value: "{10:56}", text: 'Kaleidosplode "Colorful Mess" {10:56}' }, { value: "{22:66}", text: 'Kaoson "Granted" {22:66}' },
                { value: "{25:60}", text: 'Katwaga\'s Revenge "Stormcloud" {25:60}' }, { value: "{10:7}", text: 'Kickballer "Force Bunt" {10:7}' },
                { value: "{3:75}", text: 'King\'s Gambit "Holy Hell" {3:75}' }, { value: "{12:56}", text: 'Lead Balloon "Lightweight" {12:56}' },
                { value: "{12:58}", text: 'Linebacker "Full Coverage" {12:58}' }, { value: "{20:4}", text: 'Loarmaster "???" {20:4}' },
                { value: "{18:1}", text: 'Lucian\'s Flank "Trample" {18:1}' }, { value: "{4:1}", text: 'Lucky Clover "Kismet" {4:1}' },
                { value: "{20:6}", text: 'Luty Madlad "Homemade Ingenuity" {20:6}' }, { value: "{21:83}", text: 'Matador\'s Match "Firework" {21:83}' },
                { value: "{16:68}", text: 'Midnight Defiance "Crowd Sourced" {16:68}' }, { value: "{14:76}", text: 'Murmur Event "{Unknown}" {14:76}' },
                { value: "{4:79}", text: 'Noisy Cricket "Silence" {4:79}' }, { value: "{21:59}", text: 'Ohm I Got "Energy Transfer" {21:59}' },
                { value: "{22:68}", text: 'Onslaught "Keep It Coming" {22:68}' }, { value: "{13:8}", text: 'Oscar Mike "Tactical Rouns" {13:8}' },
                { value: "{13:67}", text: 'Oscar Mike "Fragcendiary Grenades" {13:67}' }, { value: "{13:75}", text: 'Oscar Mike "Space Laser" {13:75}' },
                { value: "{3:77}", text: 'Phantom Flame "Midday" {3:77}' }, { value: "{21:62}", text: 'Plasma Coil "Superheated" {21:62}' },
                { value: "{17:77}", text: 'Potato Thrower "Spud Gun" {17:77}' }, { value: "{19:17}", text: 'Prince Harming "Pamplemousse" {19:17}' },
                { value: "{6:52}", text: 'Queen\'s Rest "Royal Armory" {6:52}' }, { value: "{9:1}", text: 'Rainbow Vomit "Color Spray..." {9:1}' },
                { value: "{2:78}", text: 'Rangefinder "Precision" {2:78}' }, { value: "{6:54}", text: 'Roach "Flesh Eaters" {6:54}' },
                { value: "{27:75}", text: 'Rowan\'s Charge "Stalker" {27:75}' }, { value: "{5:65}", text: 'Ruby\' Grasp "Grasp" {5:65}' },
                { value: "{3:80}", text: 'Seventh Sense "Proprioception" {3:80}' }, { value: "{5:67}", text: 'Sideshow "Juggler" {5:67}' },
                { value: "{3:72}", text: 'Songbird "Dueling Pistol" {3:72}' }, { value: "{13:77}", text: 'Star Helix "Constellation" {13:77}' },
                { value: "{16:72}", text: 'Stop Gap "Reconfigure" {16:72}' }, { value: "{23:20}", text: 'Stray "Stray" {23:20}' },
                { value: "{10:58}", text: 'Sweet Embrace "Adoration" {10:58}' }, { value: "{26:72}", text: 'Symmetry "Bilateral" {26:72}' },
                { value: "{9:90}", text: 'T.K\'s Wave "Heirloom" {9:90}' }, { value: "{23:21}", text: 'Vamoose "Scarce" {23:21}' },
                { value: "{18:64}", text: 'Wombo Combo "Rip Rockets" {18:64}' }, { value: "{18:92}", text: 'Whiskey Foxtrot "Scrap Cannon" {18:92}' },
                { value: "{2:1}", text: 'Zipper "Prison Rules" {2:1}' }
            ];
            processedLegendaryPerks.sort((a, b) => a.text.localeCompare(b.text));
            dataStructure.common.legendaryPerks = processedLegendaryPerks;

            // --- Process Ordnance Legendary Perks (Filtered & Grouped) ---
            const ordnanceListRaw = [
                 'Atling Gun "Whistler" {282:25} Ordnance', 'Bottled Lightning "Strike Twice" {289:26} Ordnance',
                 'Disc Jockey "Bouncing Biscuits" {275:30} Ordnance', 'Gamma Void "Radiation Exposure" {289:24} Ordnance',
                 'Inkling "Inkling" {282:2} Ordnance', 'Ravenfire "621" {273:40} Ordnance',
                 'Sidewinder "MIA" {273:38} Ordnance', 'Sprezzatura "Gungnir" {273:34} Ordnance',
                 'Ghost Skull - {272:11} *Halloween Event*', // Will be marked as Grenade
                 'Jelly "Self Replicating" {278:10} Grenade',
                 'Transmitter "Transmission" (pre-order) {278:15} Grenade', 'UAV "Death From Above" {311:8} Grenade',
                 'Swarm "Swoosh" {272:7} Grenade', 'Chaumurky "Incessant" {272:9} Grenade',
                 'Buzzaxe "Makeshift" {270:6} Grenade', 'Fuse "Fortified Position" {270:8} Grenade',
                 'Spinning Blade "Juggler" {267:9} Grenade', 'Sho Kunai "Ninja Speed" {267:11} Grenade',
                 'Firepot "Spicy" {298:6} Grenade', 'Slippy "Swordfish" {298:8} Grenade',
                 'Transmission "Pre-order" {278:15} Grenade', 'Waterfall "Waterfall" {291:8} Grenade',
                 'Blockbuster "Got You Covered" {291:6} Grenade', 'Faulty Detonator "Sticky Trigger" {311:6} Grenade',
                 'Destructo Disco "Groove" {263:10} Grenade', 'Recursive "Looping" {263:12} Grenade',
                 'Buoy "Buoyant" {278:11} Grenade', 'Streamer "Delegation" {275:1} Grenade',
                 'Disc Jockey "Bouncing Biscuits" {275:30} Grenade'
            ];
            const processedOrdnancePerks = [];
            const existingOrdnanceCodes = new Set();
            const ordnanceNameCounts = {};
            ordnanceListRaw.forEach(item => { /* Processing logic */
                let code, name, value, typeLabel = '', isGrenade = false;
                 let text = (typeof item === 'object') ? item.text : item;
                 let itemValue = (typeof item === 'object') ? item.value : null;

                 // Skip if it looks like a generic accessory format (filter step)
                 if (typeof text === 'string' && text.match(/^Generic Accessory.*\{\d+\}$/i)) {
                     return;
                 }

                const perkMatch = text.match(/^(.*?)\s*"(.*?)"\s*(\{.*?\})\s*(Ordnance|Grenade)?/i);
                const simpleMatch = text.match(/^(.*?)\s*(?:-\s*)?(\{.*?\})\s*(?:[*]?Halloween Event[*]?|Ordnance|Grenade)?/i); // Adjusted simpleMatch

                 if (perkMatch) {
                    name = `${perkMatch[1].trim()} "${perkMatch[2].trim()}"`; code = perkMatch[3];
                    if (perkMatch[4] && perkMatch[4].toLowerCase() === 'grenade') isGrenade = true;
                    typeLabel = isGrenade ? ' (Grenade)' : ' (Ordnance)';
                 } else if (simpleMatch) {
                    name = simpleMatch[1].trim().replace(/\s*-\s*$/, ''); code = simpleMatch[2];
                    if (simpleMatch[3] && simpleMatch[3].toLowerCase() === 'grenade') isGrenade = true;
                    // Specifically mark Ghost Skull as grenade
                    if (name.toLowerCase().includes('ghost skull')) isGrenade = true;
                    typeLabel = isGrenade ? ' (Grenade)' : ' (Ordnance)';
                    if (name.includes('*')) name = name.split('*')[0].trim();
                 } else { if(itemValue) { name = text.split('{')[0].trim(); code = itemValue; } else { console.warn("Skipping unparseable ordnance:", text); return; } }

                 value = code; if (existingOrdnanceCodes.has(value)) return;
                 const baseName = name.split('"')[0].trim(); const count = (ordnanceNameCounts[baseName] || 0) + 1; ordnanceNameCounts[baseName] = count;
                 if (count > 1 && !name.includes('"')) name = `${baseName} v${count}`;

                 processedOrdnancePerks.push({ value, text: `${name}${typeLabel} ${code}`, isGrenade, isGhostSkull: name.toLowerCase().includes('ghost skull') }); // Add flags for sorting
                 existingOrdnanceCodes.add(value);
            });

            // Custom Sort: Ordnance first (alpha), then Grenades (alpha, Ghost Skull first)
            processedOrdnancePerks.sort((a, b) => {
                if (a.isGrenade && !b.isGrenade) return 1; // Grenades after Ordnance
                if (!a.isGrenade && b.isGrenade) return -1; // Ordnance before Grenades
                if (a.isGrenade && b.isGrenade) {
                     if (a.isGhostSkull && !b.isGhostSkull) return -1; // Ghost Skull first in Grenades
                     if (!a.isGhostSkull && b.isGhostSkull) return 1; // Ghost Skull first in Grenades
                }
                // Fallback to alphabetical sort if types are the same or neither is Ghost Skull
                const textA = a.text.toLowerCase();
                const textB = b.text.toLowerCase();
                if (textA < textB) return -1;
                if (textA > textB) return 1;
                return 0;
            });


            dataStructure.common.ordnancePerks = processedOrdnancePerks; // Assign the grouped and sorted list

            // --- Update Decoder Lookup (Specific Parts & Generic Parts) ---
             // Clear out any pre-defined generic accessory codes from the global object
             delete globalGenericParts['3']; delete globalGenericParts['4']; delete globalGenericParts['5'];
             delete globalGenericParts['6']; delete globalGenericParts['7']; delete globalGenericParts['8'];

            // Add ordnance parts to the global lookup tables
            dataStructure.common.ordnancePerks.forEach(part => {
                 const code = part.value.replace(/[\{\}]/g, '');
                 const name = part.text.split(' (')[0].trim();
                 const func = part.isGrenade ? 'Grenade Perk/Core' : 'Heavy Weapon Perk';
                 if (code.includes(':')) {
                     globalSpecificParts[code] = {name: name, func: func};
                 } else {
                     globalGenericParts[code] = {name: name, func: func};
                 }
            });

             // Add legendary perks to the global specific parts lookup
             dataStructure.common.legendaryPerks.forEach(part => {
                 const code = part.value.replace(/[\{\}]/g, '');
                 if (code.includes(':')) {
                     const name = part.text.split('{')[0].trim();
                     globalSpecificParts[code] = {name: name, func: 'Legendary Perk Part'};
                 }
             });

            return dataStructure; // Return the fully populated structure
        })(genericParts, specificParts); // End of IIFE, pass in global lookups


        // --- Lookup Functions (Simplified) ---
        const headerLabels = {0:{label:"Item Type ID"},1:{label:"Balance ID?"},2:{label:"Grade?"},3:{label:"Item Level"},4:{label:"Seed A"},5:{label:"Seed B"}};
        const itemTypes = BASE_ITEMS.reduce((acc, item) => { acc[item.id] = item; return acc; }, {});
        // NOTE: genericParts and specificParts are now populated globally by the IIFE above.

        function getHeaderPartInfo(index,valueStr){const value=parseInt(valueStr);const info=headerLabels[index]||{label:`Unknown #${index+1}`};let details=`<code>${valueStr}</code> = ${info.label}`;let itemInfo=null;if(index===0&&itemTypes[value]){itemInfo=itemTypes[value];details+=` (<span class="font-semibold">${itemInfo.name}</span>)`;}else if(index===3){details+=` (<span class="font-semibold">Level ${value}</span>)`} return{...info,value:value,details:details,itemInfo:itemInfo}}
        function getBlockPartInfo(blockContent){if(/^\d+$/.test(blockContent)){const id=parseInt(blockContent);const part=genericParts[id]||{name:`Unknown Part ${id}`,func:"Unknown Function"};return{type:'simple',id:id,...part}} const xyMatch=blockContent.match(/^(\d+):(\d+)$/);if(xyMatch){const baseId=parseInt(xyMatch[1]);const partId=parseInt(xyMatch[2]);const key=`${baseId}:${partId}`;const baseInfo=itemTypes[baseId]||{name:`Unknown Base ${baseId}`};const part=specificParts[key]||{name:`Unknown Part ${partId} (for ${baseInfo.name})`,func:"Specific Modifier"};return{type:'xy',baseId:baseId,partId:partId,baseInfo:baseInfo,...part}} const arrayMatch=blockContent.match(/^(\d+):\s*\[(.*?)\]$/);if(arrayMatch){const setId=parseInt(arrayMatch[1]);const arrayValues=arrayMatch[2].trim().split(/\s+/).map(Number);const baseInfo=itemTypes[setId]||{name:`Unknown Set ${setId}`};return{type:'array',setId:setId,baseInfo:baseInfo,values:arrayValues,name:`${baseInfo.name} Enhancements`,func:"Stat Array"};} return{type:'unknown',idString:blockContent,name:`Malformed Block`,func:`Invalid format: {${blockContent}}`}}
        function getArrayPartInfo(setId,partValue){const key=`${setId}:${partValue}`;const specific=arrayParts[key];const generic=arrayParts['default'];const part=specific||generic||{name:`Unknown Stat ${partValue}`,func:"Stat Bonus"};const baseInfo=itemTypes[setId]||{};return{value:partValue,baseInfo:baseInfo,...part}}


        // --- Editor State & Logic ---
        let currentHeader = { itemType: '', level: '50' };
        let currentBodyParts = [];

        // --- DOM Element Variables ---
        // Declare all element variables here, so they are script-scoped
        // They will be assigned inside DOMContentLoaded
        let currentPartsList, generateButton, selectBaseItem, editLevelInput,
            editRarityPartSelect, copyFeedbackDiv, serialOutputCode,
            apiSerialOutput, detailsOutput, copyOutputBtn, copyApiBtn,
            decodeButton, outputContainer, errorMessageDiv, headerOutput,
            headerContent, blocksOutput, blocksContent, summaryOutput,
            summaryContent, tableOutput, dataTableBody, ctrlShowTable, ctrlShowSummary;


         function populatePartSelectors(itemId) {
             const commonParts = PARTS_DATA.common || {};
             const specificPartsData = PARTS_DATA[itemId] || {};

             const fillSelect = (selectId, partsArray) => {
                 const selectElement = document.getElementById(selectId);
                 if (!selectElement) { console.error(`Element with ID '${selectId}' not found.`); return; }
                 const currentValue = selectElement.value;
                 // Dynamically create placeholder text
                 let placeholder = 'Select ';
                 if (selectId === 'selectOrdnancePerk') {
                     placeholder += 'ordnance perk...'; // Specific placeholder
                 } else {
                     // Attempt to generate placeholder from ID (e.g., selectAltFire -> alt fire)
                     placeholder += selectId.replace('select', '').replace(/([A-Z])/g, ' $1').toLowerCase().trim() + '...';
                 }
                 selectElement.innerHTML = `<option value="" disabled selected>${placeholder}</option>`; // Use dynamic placeholder
                 let reselectPossible = false;
                 if (partsArray) {
                     partsArray.forEach(part => {
                         const option = document.createElement('option');
                         option.value = part.value; option.textContent = part.text;
                         selectElement.appendChild(option);
                         if (part.value === currentValue) reselectPossible = true;
                     });
                 }
                 if (reselectPossible) selectElement.value = currentValue;
             };

             fillSelect('selectElement', commonParts.elements);
             fillSelect('selectScope', commonParts.scopes);
             fillSelect('selectAltFire', commonParts.altFireModes);
             fillSelect('selectBarrel', specificPartsData.barrels);
             fillSelect('selectMagazine', commonParts.magazines);
             fillSelect('selectLegendaryPerk', commonParts.legendaryPerks);
             fillSelect('selectOrdnancePerk', commonParts.ordnancePerks); // Populate Ordnance Perks - Updated ID
         }


         function addPart(selectId) {
             const selectElement = document.getElementById(selectId);
             const partString = selectElement.value;
             const partText = selectElement.options[selectElement.selectedIndex].text;
             if (partString) {
                 if (selectId === 'editRarityPart') {
                     currentBodyParts = currentBodyParts.filter(p => !p.raw.startsWith('{9') && p.raw !== '{??}');
                     currentBodyParts.unshift({ raw: partString, display: partText });
                 } else {
                    currentBodyParts.push({ raw: partString, display: partText });
                 }
                 renderCurrentParts();
                 if (selectId !== 'editRarityPart') selectElement.selectedIndex = 0;
             }
         }

         function addArrayPart() {
             const setIdElement = document.getElementById('selectArraySetId');
             const valueElement = document.getElementById('selectArrayValue');
             const setId = setIdElement.value; const value = valueElement.value;
             const setText = setIdElement.options[setIdElement.selectedIndex].text;
             if (setId && value) {
                 let arrayPart = currentBodyParts.find(p => p.setId === setId);
                 if (arrayPart) {
                     arrayPart.values.push(parseInt(value)); arrayPart.values.sort((a, b) => a - b);
                     arrayPart.raw = `{${setId}:[${arrayPart.values.join(' ')}]}`;
                     let baseName = setText.split('{')[0].trim() || `Set ${setId}`;
                     arrayPart.display = `${baseName} {...${arrayPart.values.length} items}`;
                 } else {
                     const newValue = parseInt(value); let baseName = setText.split('{')[0].trim() || `Set ${setId}`;
                     arrayPart = { setId: setId, raw: `{${setId}:[${newValue}]}`, values: [newValue], display: `${baseName} {...1 item}` };
                     currentBodyParts.push(arrayPart);
                 }
                 renderCurrentParts(); setIdElement.selectedIndex = 0; valueElement.selectedIndex = 0;
             }
         }

         function removePart(index) { currentBodyParts.splice(index, 1); renderCurrentParts(); }

        // --- Copy Function ---
        let feedbackTimeout;
        function copyPartCode(textToCopy, buttonElement) { // Accept buttonElement to update its text
             // Create a temporary textarea element
             const textArea = document.createElement('textarea');
             textArea.value = textToCopy;
             // Make it invisible
             textArea.style.position = 'fixed'; textArea.style.left = '-9999px';
             document.body.appendChild(textArea);
             textArea.focus(); textArea.select();
             try {
                 document.execCommand('copy');
                 // Show feedback (either generic or on the button)
                 if (buttonElement) {
                     const originalText = buttonElement.textContent;
                     buttonElement.textContent = 'Copied!';
                     setTimeout(() => { buttonElement.textContent = originalText; }, 1500);
                 } else {
                     copyFeedbackDiv.classList.add('show');
                     clearTimeout(feedbackTimeout); // Clear previous timeout if any
                     feedbackTimeout = setTimeout(() => {
                         copyFeedbackDiv.classList.remove('show');
                     }, 1500); // Hide after 1.5 seconds
                 }
             } catch (err) {
                 console.error('Fallback: Oops, unable to copy', err);
                 showError('Failed to copy code to clipboard.'); // Show error in UI
             }
             document.body.removeChild(textArea); // Clean up
        }


         function renderCurrentParts() {
             currentPartsList.innerHTML = '';
             const rarityPartIndex = currentBodyParts.findIndex(p => p.raw.startsWith('{9') || p.raw.startsWith('{??}'));
             if (rarityPartIndex > 0) { const [rarityPart] = currentBodyParts.splice(rarityPartIndex, 1); currentBodyParts.unshift(rarityPart); }
             currentBodyParts.forEach((part, index) => {
                 const li = document.createElement('li');
                 const codeSpan = document.createElement('code');
                 codeSpan.textContent = part.display || part.raw;
                 codeSpan.title = part.raw;
                 li.appendChild(codeSpan);

                 // Container for buttons
                 const buttonContainer = document.createElement('div');
                 buttonContainer.classList.add('flex', 'items-center');

                 // Copy Button
                 const copyBtn = document.createElement('button');
                 copyBtn.textContent = 'Copy';
                 copyBtn.classList.add('list-button', 'copy-button'); // Add classes for styling
                 copyBtn.onclick = (e) => copyPartCode(part.raw, e.target); // Pass button ref
                 buttonContainer.appendChild(copyBtn);

                 // Remove Button
                 const removeBtn = document.createElement('button');
                 removeBtn.textContent = 'x';
                 removeBtn.classList.add('list-button', 'remove-button'); // Add classes for styling
                 removeBtn.onclick = () => removePart(index);
                 buttonContainer.appendChild(removeBtn);

                 li.appendChild(buttonContainer); // Add the button container to the list item
                 currentPartsList.appendChild(li);
             });
         }


        // --- Decoding Logic ---
        function clearOutput() { /* Hides all output sections */ headerOutput.classList.add('hidden'); blocksOutput.classList.add('hidden'); summaryOutput.classList.add('hidden'); tableOutput.classList.add('hidden'); headerContent.innerHTML = ''; blocksContent.innerHTML = ''; summaryContent.textContent = ''; dataTableBody.innerHTML = ''; }
        function showError(message) { errorMessageDiv.textContent = message; }
        function decodeHeader(headerValues) { /* Decodes header part */ let itemInfoFromHeader = null; const decoded = headerValues.map((value, index) => { const info = getHeaderPartInfo(index, value); if (info.itemInfo) itemInfoFromHeader = info.itemInfo; return info; }); return { parts: decoded, itemInfo: itemInfoFromHeader }; }
        function decodeBlocks(bodyString){ /* Decodes body part blocks */ const blockRegex=/\{(.*?)\}/g;const blocks=[];let match;const partCounts={};const placeholder="__ARRAY_BLOCK__";const arrayBlocksData=[];const processedBodyStep1=bodyString.replace(/\{(\d+:\s*\[[^\]]*?\])\}/g,(fullMatch, content)=>{arrayBlocksData.push(content);return placeholder});while((match=blockRegex.exec(processedBodyStep1))!==null){if(match[0]===placeholder)continue;const blockContent=match[1].trim();const decodedPart=getBlockPartInfo(blockContent);blocks.push(decodedPart);let countKey='';if(decodedPart.type==='simple')countKey=`simple-${decodedPart.id}`;else if(decodedPart.type==='xy')countKey=`xy-${decodedPart.baseId}:${decodedPart.partId}`;if(countKey){partCounts[countKey]=(partCounts[countKey]||0)+1}} arrayBlocksData.forEach(arrayContent=>{const decodedPart=getBlockPartInfo(arrayContent);if(decodedPart.type==='array'){blocks.push(decodedPart)}else{blocks.push({type:'unknown',idString:`{${arrayContent}}`,name:'Array Parse Error',func:'Failed to parse array block',stackCount:1})}});blocks.forEach(block=>{if(block.type==='array'||block.type==='unknown'){block.stackCount=1;return} let countKey='';if(block.type==='simple')countKey=`simple-${block.id}`;else if(block.type==='xy')countKey=`xy-${block.baseId}:${block.partId}`;if(countKey&&partCounts[countKey]>1){block.stackCount=partCounts[countKey]}else{block.stackCount=1}});return blocks}
        function renderHeader(decodedHeader){ /* Renders header output */ if(!decodedHeader||!decodedHeader.parts.length)return;let html='<ul class="list-disc pl-5">';decodedHeader.parts.forEach(part=>{html+=`<li>${part.details}</li>`});html+='</ul>';if(decodedHeader.itemInfo){html+=`<p class="mt-2 text-sm text-gray-400">Detected Item: ${decodedHeader.itemInfo.name}</p>`}else if(decodedHeader.parts[0]?.value&&!itemTypes[decodedHeader.parts[0].value]){html+=`<p class="mt-2 text-sm text-yellow-400">Warning: Item Type ID ${decodedHeader.parts[0].value} not found.</p>`} headerContent.innerHTML=html;headerOutput.classList.remove('hidden')}
        function renderBlocks(decodedBlocks){ /* Renders blocks output */ if(!decodedBlocks||!decodedBlocks.length)return;let html='<ul class="list-none pl-0">';const renderedStacks=new Set();decodedBlocks.forEach((block,index)=>{let stackKey='';if(block.type==='simple')stackKey=`simple-${block.id}`;else if(block.type==='xy')stackKey=`xy-${block.baseId}:${block.partId}`;if(stackKey&&renderedStacks.has(stackKey)){return} html+=`<li class="mb-2 border-b border-gray-700 pb-1">`;let stackText=block.stackCount>1?` (stacked  ${block.stackCount})`:'';if(block.type==='simple'){html+=`<code>{${block.id}}</code>${stackText} - <strong>${block.name}</strong>`;html+=`<div class="part-details">Function: ${block.func}</div>`}else if(block.type==='xy'){html+=`<code>{${block.baseId}:${block.partId}}</code>${stackText} - Part <strong>${block.name}</strong> for ${block.baseInfo?.name||`Unknown ${block.baseId}`}`;html+=`<div class="part-details">Function: ${block.func}</div>`}else if(block.type==='array'){html+=`<code>{${block.setId}:[...]}</code> - <strong>${block.name}</strong> (Base: ${block.baseInfo?.name||`Unknown Set ${block.setId}`})`;html+=`<div class="part-details">Function: ${block.func}</div>`;html+=`<ul class="list-disc pl-5 mt-1">`;const arrayCounts={};(block.values||[]).forEach(val=>{arrayCounts[val]=(arrayCounts[val]||0)+1});Object.entries(arrayCounts).forEach(([val,count])=>{const partInfo=getArrayPartInfo(block.setId,parseInt(val));const countText=count>1?` ( ${count})`:'';html+=`<li class="array-item text-sm"><code>${val}</code>${countText} - ${partInfo.name} <span class="text-xs text-gray-500">(${partInfo.func})</span></li>`});html+=`</ul>`}else{html+=`<code>{${block.idString||'Error'}}</code> - <span class="text-red-400">${block.name}</span>`;html+=`<div class="part-details">${block.func}</div>`} html+=`</li>`;if(stackKey&&block.stackCount>1){renderedStacks.add(stackKey)}});html+='</ul>';blocksContent.innerHTML=html;blocksOutput.classList.remove('hidden')}
        function generateSummary(allData){ /* Generates summary text */ let summary="This item is a ";const headerItemInfo=allData.header?.itemInfo;const levelPart=allData.header?.parts.find(p=>p.label==='Item Level');if(levelPart){summary+=`Level ${levelPart.value} `} if(headerItemInfo){summary+=`${headerItemInfo.name||'Item'}. `}else if(allData.header?.parts[0]?.value){summary+=`Unknown Item Type (${allData.header.parts[0].value}). `}else{summary+="Unknown item. "} summary+="It includes: ";const notableParts=[];const counts={};allData.blocks?.forEach(block=>{let key=block.name;if(block.type==='xy')key=`${block.name} (${block.baseInfo?.name||'Unknown'})`;if(block.type==='array')key=`${block.baseInfo?.name||'Unknown'} Enhancements`;if(key&&!key.startsWith('Unknown')&&!key.startsWith('Malformed')&&!key.includes('Enhancement Stat')){counts[key]=(counts[key]||0)+(block.stackCount||1)} if(block.type==='array'){const arrayCounts={};(block.values||[]).forEach(val=>{arrayCounts[val]=(arrayCounts[val]||0)+1});Object.entries(arrayCounts).forEach(([val,count])=>{const partInfo=getArrayPartInfo(block.setId,parseInt(val));if(partInfo.name!=='Enhancement Stat'){const arrayKey=`${partInfo.name}`;counts[arrayKey]=(counts[arrayKey]||0)+count}})}});Object.entries(counts).forEach(([name,count])=>{notableParts.push(`${name}${count>1?` (x${count})`:''}`)});if(notableParts.length>0){summary+=notableParts.slice(0,5).join(', ');if(notableParts.length>5)summary+=", and others.";else summary+="."}else{summary+="no specific components identified or added."} return summary}
        function renderSummary(summary){ /* Renders summary output */ summaryContent.textContent=summary;summaryOutput.classList.remove('hidden');if(ctrlShowTable.checked){summaryOutput.parentNode.insertBefore(summaryOutput,tableOutput)}}
        function generateTableData(allData){ /* Generates data for table */ const tableRows=[];allData.header?.parts.forEach((part,index)=>{tableRows.push({category:"Header",id:part.value,name:part.label,func:part.details.replace(/<\/?code>/g,'').replace(/<\/?span[^>]*>/g,'').replace(/`.*?` = /,''),stack:'-',source:part.source})});const renderedStacks=new Set();allData.blocks?.forEach(block=>{let idDisplay='';let name=block.name;let func=block.func;let source=block.source;let stack=block.stackCount>1?block.stackCount:1;let stackKey='';let category="Block";if(block.type==='simple'){idDisplay=block.id;stackKey=`simple-${idDisplay}`}else if(block.type==='xy'){idDisplay=`${block.baseId}:${block.partId}`;name=`${block.name} (Base: ${block.baseInfo?.name||'Unknown'})`;stackKey=`xy-${idDisplay}`}else if(block.type==='array'){const arrayCounts={};(block.values||[]).forEach(val=>{arrayCounts[val]=(arrayCounts[val]||0)+1});Object.entries(arrayCounts).forEach(([valStr,count])=>{const val=parseInt(valStr);const partInfo=getArrayPartInfo(block.setId,val);tableRows.push({category:`Enhancement (Set ${block.setId})`,id:val,name:partInfo.name,func:partInfo.func,stack:count,source:partInfo.source})});return}else{idDisplay=block.idString||'Error';category="Error/Unknown";stack='-'} if(stackKey&&block.stackCount>1){if(renderedStacks.has(stackKey))return;renderedStacks.add(stackKey)}else{stack=1} tableRows.push({category:category,id:idDisplay,name:name,func:func,stack:stack,source:source})});return tableRows}
        function renderTable(tableData){ /* Renders table output */ let html='';tableData.forEach(row=>{html+=`<tr><td>${row.category||''}</td><td><code>${row.id}</code></td><td>${row.name||''}</td><td>${row.func||''}</td><td>${row.stack||''}</td><td>${row.source||''}</td></tr>`});dataTableBody.innerHTML=html;tableOutput.classList.remove('hidden')}

        // --- API Call Logic (from Class Mod Editor) ---
        // CORRECTED API URL and logic
        const API_RESERIALIZE_URL = 'https://borderlands4-deserializer.nicnl.com/api/v1/reserialize';
        let reserializeAbort;

        function debounce(fn, wait) {
            let timer;
            return (...args) => { clearTimeout(timer); timer = setTimeout(() => fn(...args), wait); };
        }

        async function callReserialize() {
            if (reserializeAbort) reserializeAbort.abort();
            reserializeAbort = new AbortController();

            // Guard against elements not existing yet
            if (!apiSerialOutput || !detailsOutput || !serialOutputCode) {
                console.warn("API call attempted before elements were ready.");
                return;
            }

            const el = apiSerialOutput; // Target element for B85 serial
            const detailsEl = detailsOutput; // Target element for additional data
            const ser = serialOutputCode.textContent.trim(); // Source element

            // Check if ser is empty (due to new placeholder)
            if (!ser) {
                el.textContent = 'Waiting for input...';
                detailsEl.innerHTML = 'Waiting for input...';
                return;
            }
            el.textContent = 'Reserializing...';
            detailsEl.innerHTML = 'Working...';

            try {
                const res = await fetch(API_RESERIALIZE_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ deserialized: ser }), // Correct JSON body format
                    signal: reserializeAbort.signal
                });
                if (!res.ok){
                    const t = await res.text().catch(()=> "");
                    throw new Error(`HTTP ${res.status} ${res.statusText}${t ? "  " + t : ""}`);
                }
                const data = await res.json();
                
                // Correctly populate BOTH fields from the response
                el.textContent = data.serial_b85 || "No serial returned.";
                // Format details as a list, handling newlines
                detailsEl.innerHTML = data.additional_data ? `<ul><li>${data.additional_data.replace(/\n/g, '</li><li>')}</li></ul>` : 'No additional data.';

            } catch (e) {
                if (e.name !== 'AbortError') {
                    console.error('Reserialize error:', e);
                    const errorMsg = `Error: ${e.message}`;
                    el.textContent = errorMsg;
                    detailsEl.innerHTML = `<span class="text-red-400">${errorMsg}</span>`;
                }
            } finally {
                 reserializeAbort = null;
            }
        }

        // Debounced versions for live update
        const debouncedReserialize = debounce(callReserialize, 400);

        // --- Event Listeners ---
        // Initial setup - Wait for DOM content to be fully loaded
        document.addEventListener('DOMContentLoaded', () => {
            // --- Assign all DOM Element Variables ---
            currentPartsList = document.getElementById('currentPartsList');
            generateButton = document.getElementById('generateButton');
            selectBaseItem = document.getElementById('selectBaseItem');
            editLevelInput = document.getElementById('editLevel');
            editRarityPartSelect = document.getElementById('editRarityPart');
            copyFeedbackDiv = document.getElementById('copyFeedback');
            serialOutputCode = document.getElementById('serialOutputCode');
            apiSerialOutput = document.getElementById('apiSerialOutput');
            detailsOutput = document.getElementById('detailsOutput');
            copyOutputBtn = document.getElementById('copyOutputBtn');
            copyApiBtn = document.getElementById('copyApiBtn');
            decodeButton = document.getElementById('decodeButton');
            outputContainer = document.getElementById('outputContainer');
            errorMessageDiv = document.getElementById('errorMessage');
            headerOutput = document.getElementById('headerOutput');
            headerContent = document.getElementById('headerContent');
            blocksOutput = document.getElementById('blocksOutput');
            blocksContent = document.getElementById('blocksContent');
            summaryOutput = document.getElementById('summaryOutput');
            summaryContent = document.getElementById('summaryContent');
            tableOutput = document.getElementById('tableOutput');
            dataTableBody = document.getElementById('dataTableBody');
            ctrlShowTable = document.getElementById('ctrlShowTable');
            ctrlShowSummary = document.getElementById('ctrlShowSummary');

             // --- Add Event Listeners ---
             // Live update listener for the main serial code block
             serialOutputCode.addEventListener('input', () => {
                 debouncedReserialize();
             });

             // Copy button listeners
             copyOutputBtn.addEventListener('click', (e) => copyPartCode(serialOutputCode.textContent, e.target));
             copyApiBtn.addEventListener('click', (e) => copyPartCode(apiSerialOutput.textContent, e.target));

             // Generator/Decoder listeners
             generateButton.addEventListener('click', () => {
                 currentHeader.itemType = selectBaseItem.value; currentHeader.level = editLevelInput.value.trim() || '50';
                 const rarityPartValue = editRarityPartSelect.value;
                if (!currentHeader.itemType) { showError("Please select a Base Item Type first."); return; }
                const balanceId = '0'; const grade = '1'; const seedA = '2'; const seedB = Math.floor(Math.random() * 5000) + 1000;
                const headerString = [ currentHeader.itemType, balanceId, grade, currentHeader.level, seedA, seedB ].join(', ');
                const bodyPartsOrdered = [];
                 if (rarityPartValue && rarityPartValue !== "{??}") bodyPartsOrdered.push(rarityPartValue); else bodyPartsOrdered.push("{98}");
                currentBodyParts.forEach(part => { if (!part.raw.startsWith('{9') && part.raw !== '{??}') bodyPartsOrdered.push(part.raw); });
                const bodyString = bodyPartsOrdered.join(' '); const finalSerial = `${headerString}|| ${bodyString}`;

                 serialOutputCode.textContent = finalSerial; // Update the code block
                 clearOutput(); showError('');

                 // Trigger API calls after generating
                 callReserialize();
             });

             decodeButton.addEventListener('click', () => {
                 const serial = serialOutputCode.textContent.trim(); // Read from code block
                 clearOutput();
                 // Updated check for placeholder
                 if (!serial) {
                     showError("Serial code is empty."); return;
                 }
                 try {
                     const parts = serial.split('||'); if (parts.length < 2) throw new Error("Invalid serial format. Missing '||'.");
                     const headerString = parts[0].replace(/\|/g, ','); const bodyString = parts[1];
                     const headerPartsRaw = headerString.split(',').map(s => s.trim()).filter(s => s !== '');
                     const decodedHeader = decodeHeader(headerPartsRaw); renderHeader(decodedHeader);
                     const decodedBlocks = decodeBlocks(bodyString); renderBlocks(decodedBlocks);
                     const allDecodedData = { header: decodedHeader, blocks: decodedBlocks };
                     if (ctrlShowSummary.checked) renderSummary(generateSummary(allDecodedData));
                     if (ctrlShowTable.checked) renderTable(generateTableData(allDecodedData));
                 } catch (error) { showError(`Decoding error: ${error.message}`); console.error(error); }
             });

             // Editor listeners
             selectBaseItem.addEventListener('change', (event) => {
                 const selectedItemId = event.target.value;
                 if (selectedItemId) {
                     currentHeader.itemType = selectedItemId;
                     populatePartSelectors(selectedItemId);
                     currentBodyParts = [];
                     renderCurrentParts();
                     showError('');
                 }
             });

             // --- Initial Page Load ---
             BASE_ITEMS.forEach(item => {
                 const option = document.createElement('option');
                 option.value = item.id;
                 option.textContent = `${item.name} (${item.id})`;
                 selectBaseItem.appendChild(option);
             });
             populatePartSelectors(''); // Populate common parts initially
             renderCurrentParts();
        });

    </script>

</body>
</html>

